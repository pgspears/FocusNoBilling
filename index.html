<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clients With No Billing | FOCUS EHR Analytics Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #007acc;
            --primary-dark: #005fa3;
            --primary-light: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(52, 152, 219, 0.1) 0%, transparent 50%);
            animation: backgroundShift 20s ease infinite;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-20px, -20px) rotate(120deg); }
            66% { transform: translate(20px, -10px) rotate(240deg); }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            animation: slideDown 0.6s ease;
        }

        .header::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 0.85em;
            opacity: 0.9;
            z-index: 2;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            animation: fadeIn 0.8s ease;
            flex-wrap: wrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: var(--dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            background: rgba(102, 126, 234, 0.05);
            color: var(--primary);
        }

        .tab-btn.active {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            font-weight: 700;
        }

        .tab-content {
            display: none;
            animation: tabFade 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes tabFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            transition: box-shadow 0.3s ease;
        }

        .controls:hover {
            box-shadow: var(--hover-shadow);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 122, 204, 0.3);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 204, 0.4);
        }

        .download-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.85em;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 5px;
        }

        .download-link:hover {
            color: var(--primary-dark);
            transform: translateX(3px);
            text-decoration: underline;
        }

        input[type="number"], select {
            padding: 10px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 1em;
            min-width: 100px;
            transition: all 0.3s ease;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }

        .btn {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--success) 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }

        .btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .btn-export {
            background: linear-gradient(135deg, var(--warning) 0%, #f1c40f 100%);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-export:hover {
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #5dade2 100%);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-info:hover {
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .status {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid var(--success);
        }

        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid var(--danger);
        }

        .status.info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid var(--primary);
        }

        .status.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            color: #856404;
            border-left: 4px solid var(--warning);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            overflow-x: auto;
            transition: box-shadow 0.3s ease;
        }

        .table-container:hover {
            box-shadow: var(--hover-shadow);
        }

        .filter-bar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--dark);
        }

        .search-box {
            margin-bottom: 20px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid var(--light);
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
        }

        .search-box::before {
            content: '🔍';
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        thead {
            background: var(--bg-gradient);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.3s ease;
        }

        th:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        th:first-child {
            border-top-left-radius: 10px;
        }

        th:last-child {
            border-top-right-radius: 10px;
        }

        .sort-indicator {
            position: absolute;
            right: 10px;
            opacity: 0.7;
            transition: transform 0.3s ease;
        }

        .sort-indicator.desc {
            transform: rotate(180deg);
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light);
            transition: background 0.3s ease;
        }

        tbody tr {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            position: relative;
        }

        .detail-modal {
            max-width: 1200px;
        }

        .detail-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .detail-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .detail-item-label {
            font-size: 0.85em;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .detail-item-value {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--dark);
        }

        .billing-history-table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }

        .billing-history-table th {
            background: var(--bg-gradient);
            color: white;
            padding: 12px;
            text-align: left;
        }

        .billing-history-table td {
            padding: 12px;
            border-bottom: 1px solid var(--light);
        }

        .billing-history-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }

        .tier-red {
            background: linear-gradient(90deg, #ffe5e5 0%, #ffcccc 100%);
            border-left: 4px solid var(--danger);
        }

        .tier-orange {
            background: linear-gradient(90deg, #fff4e5 0%, #ffe4cc 100%);
            border-left: 4px solid var(--warning);
        }

        .tier-grey {
            background: linear-gradient(90deg, #f5f5f5 0%, #ebebeb 100%);
            border-left: 4px solid #999;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-critical {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        .badge-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
        }

        .badge-none {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(149, 165, 166, 0.3);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--bg-gradient);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--dark);
            font-size: 1.1em;
            font-weight: 600;
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 3em;
            opacity: 0.1;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chart-container canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        .chart-container:hover {
            box-shadow: var(--hover-shadow);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--bg-gradient);
            border-radius: 2px;
        }

        .summary-bar {
            background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            min-width: 150px;
        }

        .summary-item .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .summary-item .label {
            color: var(--dark);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            margin-top: 60px;
            padding: 30px 20px;
            text-align: center;
            color: #555;
            font-size: 0.9em;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,249,250,0.95) 100%);
            border-radius: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            position: relative;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--bg-gradient);
            border-radius: 2px;
        }

        .footer p {
            margin: 8px 0;
        }

        .footer .version-info {
            font-size: 0.85em;
            opacity: 0.7;
            color: #777;
        }

        .footer strong {
            color: var(--primary);
            font-size: 1.05em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: relative;
            background: white;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }

        .modal-header h2 {
            color: var(--primary);
            font-size: 1.8em;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .help-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .help-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .help-section p {
            line-height: 1.8;
            color: #555;
            margin-bottom: 10px;
        }

        .help-section ul, .help-section ol {
            margin-left: 30px;
            margin-top: 10px;
        }

        .help-section li {
            margin-bottom: 10px;
            color: #555;
            line-height: 1.6;
        }

        .help-section code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .help-section .tip {
            background: #d1ecf1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--info);
        }

        .help-section .warning-box {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }

        .wizard-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--light);
            z-index: 0;
        }

        .wizard-step {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }

        .wizard-step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--light);
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .wizard-step.active .wizard-step-number {
            background: var(--primary);
            color: white;
        }

        .wizard-step.completed .wizard-step-number {
            background: var(--success);
            color: white;
        }

        .wizard-step-label {
            font-size: 0.85em;
            color: #666;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .setting-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .setting-card h4 {
            color: var(--dark);
            margin-bottom: 15px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 0.9em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .fab-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--bg-gradient);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            font-size: 1.5em;
            transition: all 0.3s ease;
            position: relative;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            left: 0;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .fab-menu.active {
            display: flex;
            animation: fabMenuSlide 0.3s ease;
        }

        @keyframes fabMenuSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fab-option {
            padding: 10px 15px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--dark);
        }

        .fab-option:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .theme-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-gradient);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(180deg);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--bg-gradient);
            transition: width 0.3s ease;
        }

        .quick-filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .quick-filters h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1em;
            font-weight: 600;
        }

        .filter-group-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-group-row:last-child {
            margin-bottom: 0;
        }

        .quick-filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--light);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--dark);
        }

        .quick-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quick-filter-btn.active {
            background: var(--bg-gradient);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .quick-filter-btn.filter-critical {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .quick-filter-btn.filter-critical.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #e74c3c;
        }

        .quick-filter-btn.filter-warning {
            border-color: #f39c12;
            color: #f39c12;
        }

        .quick-filter-btn.filter-warning.active {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-color: #f39c12;
        }

        .quick-filter-btn.filter-none {
            border-color: #95a5a6;
            color: #95a5a6;
        }

        .quick-filter-btn.filter-none.active {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border-color: #95a5a6;
        }

        .quick-filter-btn.filter-pa-valid {
            border-color: #27ae60;
            color: #27ae60;
        }

        .quick-filter-btn.filter-pa-valid.active {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border-color: #27ae60;
        }

        .quick-filter-btn.filter-pa-expired {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .quick-filter-btn.filter-pa-expired.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border-color: #e74c3c;
        }

        .quick-filter-btn.filter-pa-expiring {
            border-color: #f39c12;
            color: #f39c12;
        }

        .quick-filter-btn.filter-pa-expiring.active {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-color: #f39c12;
        }

        .filter-section-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pa-category-item {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .pa-category-valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .pa-category-expired {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .pa-expiration-list {
            font-size: 0.85em;
            line-height: 1.8;
        }

        .pa-expiration-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .pa-expiration-item:last-child {
            border-bottom: none;
        }

        .pa-expiration-icon {
            font-weight: bold;
            margin-right: 6px;
            font-size: 1.1em;
        }

        .pa-expiration-valid {
            color: #27ae60;
        }

        .pa-expiration-expired {
            color: #e74c3c;
        }

        .pa-expiration-category {
            flex: 1;
            font-weight: 500;
        }

        .pa-expiration-date {
            font-weight: 600;
            margin-left: 8px;
        }

        .pa-section-header {
            font-weight: 600;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .pa-info-cell {
            padding: 8px 15px !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                padding: 15px;
            }

            table {
                font-size: 0.9em;
            }

            th, td {
                padding: 8px;
            }

            .toolbar {
                flex-direction: column;
            }

            .filter-bar {
                grid-template-columns: 1fr;
            }
        }

        .alert-banner {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .alert-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
            border-left: 4px solid var(--info);
        }

        .column-toggle {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
        }

        .column-toggle h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Clients With No Billing</h1>
            <p>Advanced Analytics Suite for FOCUS EHR | Complete Billing Gap Analysis & Management</p>
            <div class="version-badge">v3.0 Pro</div>
        </div>

        <div id="statusMessage" class="status"></div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('dashboard', event)">Dashboard</button>
            <button class="tab-btn" onclick="switchTab('analytics', event)">Analytics</button>
            <button class="tab-btn" onclick="switchTab('pa-tracker', event)">PA Tracker</button>
            <button class="tab-btn" onclick="switchTab('wizard', event)">Setup Wizard</button>
            <button class="tab-btn" onclick="switchTab('settings', event)">Settings</button>
            <button class="tab-btn" onclick="switchTab('instructions', event)">Instructions</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>Active Clients File</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="activeFile" accept=".xlsx,.xls" onchange="handleActiveFile(event)">
                        <label for="activeFile" class="file-input-label">Choose Active File</label>
                    </div>
                    <a href="https://tis.focuscbmapp.com/reports/datageniereport?id=b3e01287-9c99-4f6e-8d00-aed659bfa308&name=Client%20By%20Status" 
                       target="_blank" 
                       class="download-link">Download Client By Status from FOCUS</a>
                </div>

                <div class="control-group">
                    <label>Billing Report File</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="billingFile" accept=".xlsx,.xls" onchange="handleBillingFile(event)">
                        <label for="billingFile" class="file-input-label">Choose Billing File</label>
                    </div>
                    <a href="https://tis.focuscbmapp.com/reports/datageniereport?id=8852d61e-9634-4e04-b382-6f9b0c855c2b&name=Billing%20by%20Submission%20Date" 
                       target="_blank" 
                       class="download-link">Download Billing Report from FOCUS</a>
                </div>

                <div class="control-group">
                    <label>PA File (Optional)</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="paFile" accept=".xlsx,.xls" onchange="handlePAFile(event)">
                        <label for="paFile" class="file-input-label">Choose PA File</label>
                    </div>
                    <small style="color: #666; font-size: 0.85em;">Upload to track Prior Authorization status</small>
                </div>

                <div class="control-group">
                    <label>Look-back Days</label>
                    <input type="number" id="lookbackDays" value="30" min="1" max="365">
                </div>

                <div class="control-group">
                    <label>Warning Threshold</label>
                    <input type="number" id="warnDays" value="60" min="1" max="365">
                </div>

                <button class="btn" onclick="analyzeGaps()">Analyze Gaps</button>
                <button class="btn btn-export" onclick="exportToExcel()">Export to Excel</button>
                <button class="btn btn-secondary btn-sm" onclick="exportToCSV()">Export CSV</button>
                <button class="btn btn-info btn-sm" onclick="printReport()">Print Report</button>
            </div>

            <div id="summaryBar" class="summary-bar" style="display: none;">
                <div class="summary-item">
                    <div class="value" id="totalGaps">0</div>
                    <div class="label">Total Gaps</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="criticalCount" style="color: var(--danger);">0</div>
                    <div class="label">Critical</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="warningCount" style="color: var(--warning);">0</div>
                    <div class="label">Warning</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="noBillingCount" style="color: #999;">0</div>
                    <div class="label">No Billing</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="avgGapDays">0</div>
                    <div class="label">Avg Gap (Days)</div>
                </div>
            </div>

            <!-- Quick Filters -->
            <div id="quickFilters" class="quick-filters" style="display: none;">
                <h4>🎯 Quick Filters</h4>
                
                <div class="filter-section-label">Billing Gap Severity</div>
                <div class="filter-group-row">
                    <button class="quick-filter-btn filter-critical" onclick="toggleQuickFilter('severity', 'red')">
                        🔴 Critical Only
                    </button>
                    <button class="quick-filter-btn filter-warning" onclick="toggleQuickFilter('severity', 'orange')">
                        🟡 Warning Only
                    </button>
                    <button class="quick-filter-btn filter-none" onclick="toggleQuickFilter('severity', 'grey')">
                        ⚪ No Billing Only
                    </button>
                </div>

                <div class="filter-section-label">Days Since Last Billing</div>
                <div class="filter-group-row">
                    <button class="quick-filter-btn" onclick="toggleQuickFilter('days', '30-60')">
                        31-60 Days
                    </button>
                    <button class="quick-filter-btn" onclick="toggleQuickFilter('days', '60-90')">
                        61-90 Days
                    </button>
                    <button class="quick-filter-btn" onclick="toggleQuickFilter('days', '90-120')">
                        91-120 Days
                    </button>
                    <button class="quick-filter-btn" onclick="toggleQuickFilter('days', '120+')">
                        120+ Days
                    </button>
                </div>

                <div id="paQuickFilters" style="display: none;">
                    <div class="filter-section-label">PA Authorization Status</div>
                    <div class="filter-group-row">
                        <button class="quick-filter-btn filter-pa-valid" onclick="toggleQuickFilter('pa', 'valid')">
                            ✅ Valid PA
                        </button>
                        <button class="quick-filter-btn filter-pa-expiring" onclick="toggleQuickFilter('pa', 'expiring')">
                            ⚠️ PA Expiring Soon
                        </button>
                        <button class="quick-filter-btn filter-pa-expired" onclick="toggleQuickFilter('pa', 'expired')">
                            ❌ Expired PA
                        </button>
                        <button class="quick-filter-btn" onclick="toggleQuickFilter('pa', 'none')">
                            ⚪ No PA
                        </button>
                    </div>
                </div>

                <div class="filter-group-row" style="margin-top: 15px;">
                    <button class="btn btn-sm btn-secondary" onclick="clearAllQuickFilters()">Clear All Filters</button>
                    <span id="activeFilterCount" style="margin-left: 10px; color: var(--primary); font-weight: 600;"></span>
                </div>
            </div>

            <div id="spinner" class="spinner"></div>

            <div id="tableContainer" class="table-container" style="display: none;">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-sm btn-secondary" onclick="toggleFilters()">Toggle Filters</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleColumnSelector()">Select Columns</button>
                        <button class="btn btn-sm btn-info" onclick="refreshData()">Refresh</button>
                    </div>
                    <div class="toolbar-right">
                        <span id="rowCount">Showing 0 rows</span>
                    </div>
                </div>

                <div id="columnToggle" class="column-toggle" style="display: none;">
                    <h4>Select Visible Columns</h4>
                    <div class="column-checkboxes" id="columnCheckboxes"></div>
                </div>

                <div id="filterBar" class="filter-bar" style="display: none;">
                    <div class="filter-group">
                        <label>Tier Filter</label>
                        <select id="tierFilter" onchange="applyFilters()">
                            <option value="all">All Tiers</option>
                            <option value="red">Critical Only</option>
                            <option value="orange">Warning Only</option>
                            <option value="grey">No Billing Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Provider Filter</label>
                        <select id="providerFilter" onchange="applyFilters()">
                            <option value="all">All Providers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Service Filter</label>
                        <select id="serviceFilter" onchange="applyFilters()">
                            <option value="all">All Services</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fund Filter</label>
                        <select id="fundFilter" onchange="applyFilters()">
                            <option value="all">All Funds</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Min Days</label>
                        <input type="number" id="minDaysFilter" min="0" placeholder="Min" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Max Days</label>
                        <input type="number" id="maxDaysFilter" min="0" placeholder="Max" onchange="applyFilters()">
                    </div>
                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-sm btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search by name, provider, service, or fund..." onkeyup="filterTable()">
                </div>
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-grid">
                <div class="stat-card">
                    <div class="stat-icon">📊</div>
                    <div class="stat-value" id="avgDaysSince">0</div>
                    <div class="stat-label">Average Days Since Billing</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value" id="uniqueProviders">0</div>
                    <div class="stat-label">Active Providers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🏥</div>
                    <div class="stat-value" id="uniqueServices">0</div>
                    <div class="stat-label">Service Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-value" id="urgentPercent">0%</div>
                    <div class="stat-label">Urgent Action Required</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">💰</div>
                    <div class="stat-value" id="uniqueFunds">0</div>
                    <div class="stat-label">Funding Sources</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📈</div>
                    <div class="stat-value" id="maxGapDays">0</div>
                    <div class="stat-label">Longest Gap (Days)</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Gap Distribution by Severity</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="severityChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Service Type Analysis</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Provider Performance</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="providerChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Days Since Billing Distribution</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="daysDistChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Funding Source Breakdown</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="fundChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PA Tracker Tab -->
        <div id="pa-tracker-tab" class="tab-content">
            <div class="alert-banner alert-info" id="paInfoBanner" style="display: none;">
                <span>📋</span>
                <span>PA data uploaded successfully. Showing authorization status for all clients.</span>
            </div>

            <div class="analytics-grid">
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="paValidCount">0</div>
                    <div class="stat-label">Valid Authorizations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">❌</div>
                    <div class="stat-value" id="paExpiredCount">0</div>
                    <div class="stat-label">Expired Authorizations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">⚠️</div>
                    <div class="stat-value" id="paExpiringSoonCount">0</div>
                    <div class="stat-label">Expiring Within 30 Days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📄</div>
                    <div class="stat-value" id="paTotalAuths">0</div>
                    <div class="stat-label">Total Authorizations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🔍</div>
                    <div class="stat-value" id="paUniqueCategories">0</div>
                    <div class="stat-label">Authorization Types</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👤</div>
                    <div class="stat-value" id="paClientsWithPA">0</div>
                    <div class="stat-label">Clients with PA</div>
                </div>
            </div>

            <div class="table-container">
                <h3 style="margin-bottom: 20px; color: var(--primary);">Prior Authorization Status by Client</h3>
                
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-sm btn-secondary" onclick="togglePAFilters()">Toggle Filters</button>
                        <button class="btn btn-sm btn-info" onclick="exportPAToExcel()">Export PA Data</button>
                    </div>
                    <div class="toolbar-right">
                        <span id="paRowCount">Showing 0 clients</span>
                    </div>
                </div>

                <div id="paFilterBar" class="filter-bar" style="display: none;">
                    <div class="filter-group">
                        <label>PA Status</label>
                        <select id="paStatusFilter" onchange="filterPATable()">
                            <option value="all">All Statuses</option>
                            <option value="valid">Valid Only</option>
                            <option value="expired">Expired Only</option>
                            <option value="expiring">Expiring Soon</option>
                            <option value="none">No PA</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Category Filter</label>
                        <select id="paCategoryFilter" onchange="filterPATable()">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Funding Filter</label>
                        <select id="paFundingFilter" onchange="filterPATable()">
                            <option value="all">All Funding Sources</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-sm btn-secondary" onclick="clearPAFilters()">Clear Filters</button>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="paSearchInput" placeholder="Search by client name..." onkeyup="filterPATable()">
                </div>

                <table id="paTable">
                    <thead>
                        <tr>
                            <th onclick="sortPATable(0)">Client Name <span class="sort-indicator">▼</span></th>
                            <th onclick="sortPATable(1)">PA Status <span class="sort-indicator">▼</span></th>
                            <th onclick="sortPATable(2)">Active PAs <span class="sort-indicator">▼</span></th>
                            <th onclick="sortPATable(3)">Expired PAs <span class="sort-indicator">▼</span></th>
                            <th onclick="sortPATable(4)">All Categories <span class="sort-indicator">▼</span></th>
                            <th onclick="sortPATable(5)">All Expirations <span class="sort-indicator">▼</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paTableBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                                Upload a PA file to view authorization status
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-container" id="paChartsContainer" style="display: none;">
                <div class="chart-title">PA Status Distribution</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="paStatusChart"></canvas>
                </div>
            </div>

            <div class="chart-container" id="paCategoryChartContainer" style="display: none;">
                <div class="chart-title">Authorization Categories</div>
                <div style="position: relative; height: 300px; width: 100%; overflow: hidden;">
                    <canvas id="paCategoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Setup Wizard Tab -->
        <div id="wizard-tab" class="tab-content">
            <div class="wizard-container">
                <h2 style="margin-bottom: 30px; color: var(--primary);">Quick Setup Wizard</h2>
                
                <div class="wizard-steps">
                    <div class="wizard-step active" id="wizardStep1">
                        <div class="wizard-step-number">1</div>
                        <div class="wizard-step-label">Download Files</div>
                    </div>
                    <div class="wizard-step" id="wizardStep2">
                        <div class="wizard-step-number">2</div>
                        <div class="wizard-step-label">Upload Files</div>
                    </div>
                    <div class="wizard-step" id="wizardStep3">
                        <div class="wizard-step-number">3</div>
                        <div class="wizard-step-label">Configure</div>
                    </div>
                    <div class="wizard-step" id="wizardStep4">
                        <div class="wizard-step-number">4</div>
                        <div class="wizard-step-label">Analyze</div>
                    </div>
                </div>

                <div id="wizardContent1" class="wizard-content active">
                    <h3>Step 1: Download Required Files from FOCUS EHR</h3>
                    <div class="help-section">
                        <p>Download the following reports from FOCUS EHR:</p>
                        <ol>
                            <li><strong>Client By Status Report:</strong> Contains all active client information
                                <br><a href="https://tis.focuscbmapp.com/reports/datageniereport?id=b3e01287-9c99-4f6e-8d00-aed659bfa308&name=Client%20By%20Status" target="_blank" class="btn btn-sm" style="margin-top: 10px;">Download Client By Status</a>
                            </li>
                            <li><strong>Billing by Submission Report:</strong> Contains billing submission history
                                <br><a href="https://tis.focuscbmapp.com/reports/datageniereport?id=8852d61e-9634-4e04-b382-6f9b0c855c2b&name=Billing%20by%20Submission%20Date" target="_blank" class="btn btn-sm" style="margin-top: 10px;">Download Billing Report</a>
                            </li>
                        </ol>
                        <div class="tip">
                            <strong>Tip:</strong> Save both files to an easily accessible location on your computer. Keep them in .xlsx format.
                        </div>
                    </div>
                    <button class="btn" onclick="wizardNext(2)">Next Step</button>
                </div>

                <div id="wizardContent2" class="wizard-content" style="display: none;">
                    <h3>Step 2: Upload Your Files</h3>
                    <div class="help-section">
                        <div class="control-group" style="margin-bottom: 20px;">
                            <label>Active Clients File (.xlsx)</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="wizardActiveFile" accept=".xlsx,.xls" onchange="wizardHandleActiveFile(event)">
                                <label for="wizardActiveFile" class="file-input-label">Choose Active File</label>
                            </div>
                            <span id="wizardActiveStatus" style="color: var(--success); font-weight: bold; margin-top: 10px;"></span>
                        </div>
                        
                        <div class="control-group">
                            <label>Billing Report File (.xlsx)</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="wizardBillingFile" accept=".xlsx,.xls" onchange="wizardHandleBillingFile(event)">
                                <label for="wizardBillingFile" class="file-input-label">Choose Billing File</label>
                            </div>
                            <span id="wizardBillingStatus" style="color: var(--success); font-weight: bold; margin-top: 10px;"></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="wizardPrevious(1)">Previous</button>
                        <button class="btn" id="wizardStep2Next" onclick="wizardNext(3)" disabled>Next Step</button>
                    </div>
                </div>

                <div id="wizardContent3" class="wizard-content" style="display: none;">
                    <h3>Step 3: Configure Analysis Parameters</h3>
                    <div class="help-section">
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>Look-back Days (Default: 30)</label>
                                <input type="number" id="wizardLookback" value="30" min="1" max="365" style="width: 100%;">
                                <small>Number of days to consider as a billing gap</small>
                            </div>
                            <div class="setting-item">
                                <label>Warning Threshold (Default: 60)</label>
                                <input type="number" id="wizardWarn" value="60" min="1" max="365" style="width: 100%;">
                                <small>Days after which gap becomes critical</small>
                            </div>
                        </div>
                        <div class="tip">
                            <strong>Recommended Settings:</strong>
                            <ul>
                                <li>Look-back Days: 30 (identifies gaps over 1 month)</li>
                                <li>Warning Threshold: 60 (marks gaps over 2 months as critical)</li>
                            </ul>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="wizardPrevious(2)">Previous</button>
                        <button class="btn" onclick="wizardNext(4)">Next Step</button>
                    </div>
                </div>

                <div id="wizardContent4" class="wizard-content" style="display: none;">
                    <h3>Step 4: Run Analysis</h3>
                    <div class="help-section">
                        <p>You're all set! Click the button below to analyze billing gaps.</p>
                        <div id="wizardProgress" style="display: none;">
                            <p>Analyzing data...</p>
                            <div class="progress-bar">
                                <div class="progress-fill" id="wizardProgressBar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="wizardPrevious(3)">Previous</button>
                        <button class="btn" onclick="wizardAnalyze()">Run Analysis</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="table-container">
                <h2 style="margin-bottom: 20px;">Advanced Settings & Configuration</h2>
                
                <div class="settings-grid">
                    <div class="setting-card">
                        <h4>Display Preferences</h4>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showEmojis" checked onchange="saveSettings()">
                                <label for="showEmojis">Show emoji icons</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="compactView" onchange="saveSettings()">
                                <label for="compactView">Compact table view</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="autoRefresh" onchange="saveSettings()">
                                <label for="autoRefresh">Auto-refresh data</label>
                            </div>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h4>Analysis Options</h4>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="enableFuzzyMatch" checked onchange="saveSettings()">
                                <label for="enableFuzzyMatch">Enable fuzzy name matching</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="excludeHRFunding" checked onchange="saveSettings()">
                                <label for="excludeHRFunding">Exclude HR funding</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Fuzzy Match Threshold</label>
                            <input type="number" id="fuzzyThreshold" value="80" min="0" max="100" step="5" onchange="saveSettings()">
                            <small>Higher = stricter matching (0-100)</small>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h4>Export Options</h4>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="includeCharts" checked onchange="saveSettings()">
                                <label for="includeCharts">Include charts in Excel export</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="includeSummary" checked onchange="saveSettings()">
                                <label for="includeSummary">Include summary sheet</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Export Format</label>
                            <select id="exportFormat" onchange="saveSettings()">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="csv">CSV (.csv)</option>
                                <option value="both">Both formats</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h4>Notification Settings</h4>
                        <div class="setting-item">
                            <div class="checkbox-group">
                                <input type="checkbox" id="showAlerts" checked onchange="saveSettings()">
                                <label for="showAlerts">Show status alerts</label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Alert Duration (seconds)</label>
                            <input type="number" id="alertDuration" value="5" min="1" max="30" onchange="saveSettings()">
                        </div>
                    </div>

                    <div class="setting-card">
                        <h4>Data Management</h4>
                        <div class="setting-item">
                            <button class="btn btn-secondary btn-sm" onclick="exportSettings()">Export Settings</button>
                        </div>
                        <div class="setting-item">
                            <button class="btn btn-secondary btn-sm" onclick="importSettings()">Import Settings</button>
                        </div>
                        <div class="setting-item">
                            <button class="btn btn-secondary btn-sm" onclick="resetSettings()">Reset to Defaults</button>
                        </div>
                    </div>

                    <div class="setting-card">
                        <h4>About</h4>
                        <p><strong>Version:</strong> 3.0 Pro</p>
                        <p><strong>Build:</strong> 2025-01-20</p>
                        <p><strong>License:</strong> Accelerate Solutions, LLC</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions Tab -->
        <div id="instructions-tab" class="tab-content">
            <div class="table-container">
                <h2 style="margin-bottom: 20px; color: var(--primary);">Complete User Guide & Documentation</h2>

                <div class="help-section">
                    <h3>Table of Contents</h3>
                    <ol>
                        <li><a href="#getting-started" style="color: var(--primary);">Getting Started</a></li>
                        <li><a href="#file-requirements" style="color: var(--primary);">File Requirements</a></li>
                        <li><a href="#analysis-process" style="color: var(--primary);">Analysis Process</a></li>
                        <li><a href="#understanding-results" style="color: var(--primary);">Understanding Results</a></li>
                        <li><a href="#advanced-features" style="color: var(--primary);">Advanced Features</a></li>
                        <li><a href="#troubleshooting" style="color: var(--primary);">Troubleshooting</a></li>
                        <li><a href="#best-practices" style="color: var(--primary);">Best Practices</a></li>
                        <li><a href="#faq" style="color: var(--primary);">Frequently Asked Questions</a></li>
                        <li><a href="#pa-tracking" style="color: var(--primary);">Prior Authorization (PA) Tracking</a></li>
                    </ol>
                </div>

                <div class="help-section" id="getting-started">
                    <h3>1. Getting Started</h3>
                    <p>This tool identifies clients in your FOCUS EHR system who have billing gaps and tracks Prior Authorization (PA) status, helping you maintain consistent service documentation, revenue flow, and compliance.</p>
                    
                    <h4>Quick Start Steps:</h4>
                    <ol>
                        <li>Navigate to the <strong>Setup Wizard</strong> tab for guided setup</li>
                        <li>Download required reports from FOCUS EHR using provided links</li>
                        <li>Upload both files (Active Clients and Billing Report)</li>
                        <li>Optionally upload PA file to track authorization status</li>
                        <li>Configure analysis parameters (or use defaults)</li>
                        <li>Click "Analyze Gaps" to generate your report</li>
                        <li>View PA tracking in the dedicated <strong>PA Tracker</strong> tab</li>
                    </ol>

                    <div class="tip">
                        <strong>New User Tip:</strong> Start with the Setup Wizard tab for a step-by-step guided experience. It will walk you through the entire process.
                    </div>
                </div>

                <div class="help-section" id="pa-tracking">
                    <h3>9. Prior Authorization (PA) Tracking</h3>
                    
                    <h4>Overview:</h4>
                    <p>The PA Tracker provides comprehensive visibility into client authorization status, helping you ensure compliance and avoid service interruptions.</p>

                    <h4>PA File Requirements:</h4>
                    <p>The PA file must be an Excel file (.xlsx or .xls) containing:</p>
                    <ul>
                        <li><code>Name</code> - Client name (must match Active Clients file)</li>
                        <li><code>Status</code> - PA status (VALID or EXPIRED)</li>
                        <li><code>Category</code> - Authorization category/type</li>
                        <li><code>ExpiresOn</code> - Expiration date</li>
                        <li><code>FundingSource</code> - Funding source for the PA</li>
                        <li><code>Approved</code> - Approval status (Yes/No)</li>
                        <li><code>Title</code> - PA description (optional)</li>
                    </ul>

                    <h4>PA Status Categories:</h4>
                    <ul>
                        <li><strong>✅ Valid:</strong> PA is currently active and not expiring within 30 days</li>
                        <li><strong>⚠️ Expiring Soon:</strong> Valid PA expiring within the next 30 days</li>
                        <li><strong>❌ Expired:</strong> PA expiration date has passed</li>
                        <li><strong>⚪ No PA:</strong> No authorization records found for this client</li>
                    </ul>

                    <h4>Using the PA Tracker:</h4>
                    <ol>
                        <li>Upload your PA file using the PA File upload control in the Dashboard</li>
                        <li>Navigate to the <strong>PA Tracker</strong> tab</li>
                        <li>View summary statistics showing valid, expired, and expiring authorizations</li>
                        <li>Review the client-by-client PA status table</li>
                        <li>Use filters to focus on specific status types, categories, or funding sources</li>
                        <li>Click "View Details" on any client to see all their PA records</li>
                        <li>Export PA data to Excel for reporting and sharing</li>
                    </ol>

                    <h4>PA Integration with Dashboard:</h4>
                    <p>When PA data is uploaded, three additional columns appear in the main Dashboard:</p>
                    <ul>
                        <li><strong>PA Status:</strong> Overall authorization status for the client</li>
                        <li><strong>PA Types:</strong> List of active authorization categories</li>
                        <li><strong>PA Expires:</strong> Date of nearest PA expiration</li>
                    </ul>

                    <div class="tip">
                        <strong>Pro Tip:</strong> Use the PA Tracker to identify clients whose authorizations are expiring soon, allowing you to initiate renewal processes before services are interrupted.
                    </div>

                    <h4>PA Alerts:</h4>
                    <ul>
                        <li>Clients with PAs expiring within 30 days are highlighted in orange</li>
                        <li>Clients with expired PAs are highlighted in red</li>
                        <li>The dashboard shows count of expiring authorizations in statistics</li>
                    </ul>

                    <h4>Best Practices for PA Management:</h4>
                    <ul>
                        <li>Review PA Tracker weekly to identify upcoming expirations</li>
                        <li>Filter by "Expiring Soon" to prioritize renewal actions</li>
                        <li>Export PA data monthly for compliance documentation</li>
                        <li>Cross-reference billing gaps with PA status to identify service authorization issues</li>
                        <li>Use the "View Details" function to review all authorizations for complex cases</li>
                        <li>Monitor category-specific PAs to ensure all service types are covered</li>
                    </ul>

                    <h4>Common PA Scenarios:</h4>
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr style="background: var(--light);">
                            <th style="padding: 10px; text-align: left;">Scenario</th>
                            <th style="padding: 10px; text-align: left;">Action</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Client has billing gap AND expired PA</td>
                            <td style="padding: 10px;">Priority action - renew PA before resuming services</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px;">PA expiring in 15 days</td>
                            <td style="padding: 10px;">Initiate renewal process immediately</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Multiple PAs with different expiration dates</td>
                            <td style="padding: 10px;">Track nearest expiration, plan staggered renewals</td>
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 10px;">Active billing but no PA record</td>
                            <td style="padding: 10px;">Verify if PA is required for this service type</td>
                        </tr>
                    </table>
                </div>

                <div class="help-section" id="file-requirements">
                    <h3>2. File Requirements</h3>
                    
                    <h4>Active Clients File Requirements:</h4>
                    <p>Must be an Excel file (.xlsx or .xls) containing:</p>
                    <ul>
                        <li><code>MAID</code> - Client unique identifier</li>
                        <li><code>Name</code> - Client full name</li>
                        <li><code>Status</code> - Client status (must include "Active" clients)</li>
                        <li><code>Funding</code> - Funding source (e.g., MED, COM, PRI)</li>
                    </ul>

                    <h4>Billing Report File Requirements:</h4>
                    <p>Must be an Excel file (.xlsx or .xls) containing:</p>
                    <ul>
                        <li><code>MAID</code> - Client unique identifier (must match Active Clients file)</li>
                        <li><code>FullName</code> - Client full name</li>
                        <li><code>Begin Date</code> - Service/billing date</li>
                        <li><code>Created By</code> - Provider name</li>
                        <li><code>Title</code> - Service type/description</li>
                    </ul>

                    <div class="warning-box">
                        <strong>Important:</strong> Column names must match exactly (case-sensitive). Extra columns are okay and will be ignored.
                    </div>

                    <h4>Where to Get Files:</h4>
                    <ul>
                        <li><strong>Client By Status:</strong> <a href="https://tis.focuscbmapp.com/reports/datageniereport?id=b3e01287-9c99-4f6e-8d00-aed659bfa308&name=Client%20By%20Status" target="_blank">Direct Link</a></li>
                        <li><strong>Billing Report:</strong> <a href="https://tis.focuscbmapp.com/reports/datageniereport?id=8852d61e-9634-4e04-b382-6f9b0c855c2b&name=Billing%20by%20Submission%20Date" target="_blank">Direct Link</a></li>
                    </ul>
                </div>

                <div class="help-section" id="analysis-process">
                    <h3>3. Analysis Process</h3>
                    
                    <h4>How the Analysis Works:</h4>
                    <ol>
                        <li><strong>Data Loading:</strong> Files are read and validated for required columns</li>
                        <li><strong>Active Client Filtering:</strong> Only clients with "Active" status are analyzed</li>
                        <li><strong>HR Exclusion:</strong> Clients with "HR" in funding are excluded (configurable)</li>
                        <li><strong>Billing Lookup:</strong> System matches clients to their most recent billing record by MAID</li>
                        <li><strong>Fuzzy Matching:</strong> If MAID fails, attempts name-based matching (configurable)</li>
                        <li><strong>Gap Calculation:</strong> Days since last billing are calculated from today's date</li>
                        <li><strong>Tier Assignment:</strong> Gaps are classified as Critical, Warning, or No Billing</li>
                    </ol>

                    <h4>Configuration Parameters:</h4>
                    <ul>
                        <li><strong>Look-back Days (default: 30):</strong> Minimum days without billing to be considered a gap</li>
                        <li><strong>Warning Threshold (default: 60):</strong> Days after which a gap becomes critical</li>
                    </ul>

                    <h4>Example Scenarios:</h4>
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr style="background: var(--light);">
                            <th style="padding: 10px; text-align: left;">Days Since Last Bill</th>
                            <th style="padding: 10px; text-align: left;">Classification</th>
                            <th style="padding: 10px; text-align: left;">Color</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">0-30 days</td>
                            <td style="padding: 10px;">Not a gap (excluded from results)</td>
                            <td style="padding: 10px;">-</td>
                        </tr>
                        <tr style="background: #fff4e5;">
                            <td style="padding: 10px;">31-60 days</td>
                            <td style="padding: 10px;">Warning</td>
                            <td style="padding: 10px;">Orange</td>
                        </tr>
                        <tr style="background: #ffe5e5;">
                            <td style="padding: 10px;">61+ days</td>
                            <td style="padding: 10px;">Critical</td>
                            <td style="padding: 10px;">Red</td>
                        </tr>
                        <tr style="background: #f5f5f5;">
                            <td style="padding: 10px;">No billing record</td>
                            <td style="padding: 10px;">No Billing</td>
                            <td style="padding: 10px;">Grey</td>
                        </tr>
                    </table>
                </div>

                <div class="help-section" id="understanding-results">
                    <h3>4. Understanding Results</h3>
                    
                    <h4>Gap Tier Classifications:</h4>
                    <ul>
                        <li><strong>🔴 Critical (Red):</strong> No billing for more than 60 days. Requires immediate action to prevent revenue loss and ensure proper documentation.</li>
                        <li><strong>🟡 Warning (Orange):</strong> No billing for 31-60 days. Should be reviewed soon to prevent escalation to critical status.</li>
                        <li><strong>⚪ No Billing (Grey):</strong> No billing record found in the system. May indicate new clients not yet billed or clients who have never been billed.</li>
                    </ul>

                    <h4>Dashboard Summary Bar:</h4>
                    <ul>
                        <li><strong>Total Gaps:</strong> Total number of active clients with billing gaps</li>
                        <li><strong>Critical:</strong> Count of red-tier gaps requiring urgent attention</li>
                        <li><strong>Warning:</strong> Count of orange-tier gaps to monitor</li>
                        <li><strong>No Billing:</strong> Count of clients with no billing history</li>
                        <li><strong>Avg Gap (Days):</strong> Average days since last billing across all gaps</li>
                    </ul>

                    <h4>Table Columns Explained:</h4>
                    <ul>
                        <li><strong>Name:</strong> Client's full name from Active Clients file</li>
                        <li><strong>Fund:</strong> First 3 characters of funding source (e.g., MED, COM, PRI)</li>
                        <li><strong>Provider:</strong> Last person who created a billing entry</li>
                        <li><strong>Service:</strong> Type of service from most recent billing</li>
                        <li><strong>Last Bill:</strong> Date of most recent billing entry</li>
                        <li><strong>Days Since:</strong> Number of days from last billing to today</li>
                        <li><strong>Status:</strong> Gap tier classification with badge</li>
                    </ul>
                </div>

                <div class="help-section" id="advanced-features">
                    <h3>5. Advanced Features</h3>
                    
                    <h4>Filtering & Search:</h4>
                    <ul>
                        <li><strong>Quick Search:</strong> Type in the search box to find specific clients, providers, or services</li>
                        <li><strong>Advanced Filters:</strong> Click "Toggle Filters" to access tier, provider, service, fund, and date range filters</li>
                        <li><strong>Multi-Filter:</strong> Combine multiple filters for precise data views</li>
                        <li><strong>Clear Filters:</strong> Reset all filters to view complete dataset</li>
                    </ul>

                    <h4>Column Management:</h4>
                    <ul>
                        <li>Click "Select Columns" to show/hide specific columns</li>
                        <li>Customize your view based on what information is most important</li>
                        <li>Settings persist across sessions</li>
                    </ul>

                    <h4>Sorting:</h4>
                    <ul>
                        <li>Click any column header to sort by that column</li>
                        <li>Click again to reverse sort direction</li>
                        <li>Visual indicators show current sort column and direction</li>
                    </ul>

                    <h4>Export Options:</h4>
                    <ul>
                        <li><strong>Excel Export:</strong> Multi-sheet workbook with data, summary, provider analysis, and service breakdown</li>
                        <li><strong>CSV Export:</strong> Simple comma-separated format for external tools</li>
                        <li><strong>Print Report:</strong> Print-friendly formatted view of current data</li>
                    </ul>

                    <h4>Analytics Dashboard:</h4>
                    <p>The Analytics tab provides visual insights including:</p>
                    <ul>
                        <li>Gap distribution by severity (pie chart)</li>
                        <li>Service type analysis (bar chart)</li>
                        <li>Provider performance comparison (horizontal bar chart)</li>
                        <li>Days distribution histogram</li>
                        <li>Funding source breakdown (new in v3.0)</li>
                    </ul>
                </div>

                <div class="help-section" id="troubleshooting">
                    <h3>6. Troubleshooting Guide</h3>
                    
                    <h4>Common Issues & Solutions:</h4>
                    
                    <p><strong>Issue:</strong> "Error reading active clients file"</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Ensure file is in .xlsx or .xls format</li>
                        <li>Verify file contains required columns: MAID, Name, Status, Funding</li>
                        <li>Check that column names match exactly (case-sensitive)</li>
                        <li>Make sure file is not corrupted - try re-downloading from FOCUS</li>
                    </ul>

                    <p><strong>Issue:</strong> "No gaps found" when you expect results</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Check your Look-back Days setting - try increasing it</li>
                        <li>Verify both files contain matching MAIDs</li>
                        <li>Ensure Active Clients file has clients with Status = "Active"</li>
                        <li>Check that Billing Report has recent dates</li>
                    </ul>

                    <p><strong>Issue:</strong> Incorrect gap counts or missing clients</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Enable fuzzy name matching in Settings if MAID matching fails</li>
                        <li>Adjust fuzzy match threshold (lower = more lenient)</li>
                        <li>Verify client names are spelled consistently between files</li>
                        <li>Check for HR-funded clients being excluded (configurable)</li>
                    </ul>

                    <p><strong>Issue:</strong> Charts not displaying</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Switch to another tab and back to Analytics</li>
                        <li>Refresh the page and re-run analysis</li>
                        <li>Ensure you have data (run analysis first)</li>
                        <li>Check browser console for errors (F12)</li>
                    </ul>

                    <p><strong>Issue:</strong> Export not working</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Ensure you have data to export (run analysis first)</li>
                        <li>Check browser allows downloads from this site</li>
                        <li>Try a different export format (CSV vs Excel)</li>
                        <li>Disable browser extensions that may block downloads</li>
                    </ul>

                    <div class="warning-box">
                        <strong>Still Having Issues?</strong> Clear your browser cache, reload the page, and try again. If problems persist, export your settings and data, then try in a different browser.
                    </div>
                </div>

                <div class="help-section" id="best-practices">
                    <h3>7. Best Practices</h3>
                    
                    <h4>For Optimal Results:</h4>
                    <ul>
                        <li><strong>Run Weekly:</strong> Analyze gaps every Monday to catch issues early</li>
                        <li><strong>Prioritize Critical:</strong> Address red-tier gaps first, especially those over 90 days</li>
                        <li><strong>Track Trends:</strong> Export results weekly to identify patterns over time</li>
                        <li><strong>Provider Accountability:</strong> Use Provider Performance chart to identify training needs</li>
                        <li><strong>Document Actions:</strong> Keep notes on actions taken for each gap</li>
                    </ul>

                    <h4>Workflow Recommendations:</h4>
                    <ol>
                        <li>Download fresh reports from FOCUS every time (don't reuse old files)</li>
                        <li>Run analysis and export to Excel immediately</li>
                        <li>Sort by Days Since (descending) to tackle worst gaps first</li>
                        <li>Assign gaps to specific staff for follow-up</li>
                        <li>Re-run analysis after addressing gaps to verify improvements</li>
                        <li>Archive weekly exports for historical tracking</li>
                    </ol>

                    <h4>Settings Recommendations:</h4>
                    <ul>
                        <li><strong>Look-back Days:</strong> Keep at 30 for monthly billing cycles</li>
                        <li><strong>Warning Threshold:</strong> Set to 60 for bi-monthly review points</li>
                        <li><strong>Fuzzy Matching:</strong> Enable with 80% threshold for best balance</li>
                        <li><strong>HR Exclusion:</strong> Keep enabled unless specifically analyzing HR-funded clients</li>
                    </ul>

                    <h4>Team Collaboration:</h4>
                    <ul>
                        <li>Use filters to assign providers their own gaps for review</li>
                        <li>Export provider-specific reports from filtered views</li>
                        <li>Hold weekly review meetings using Analytics charts</li>
                        <li>Set department goals based on gap reduction percentages</li>
                    </ul>
                </div>

                <div class="help-section" id="faq">
                    <h3>8. Frequently Asked Questions</h3>
                    
                    <h4>Q: What does "fuzzy matching" mean?</h4>
                    <p><strong>A:</strong> Fuzzy matching helps find clients even when names are slightly different between files (e.g., "Smith, John" vs "John Smith"). The algorithm calculates similarity scores and matches if above the threshold (default 80%).</p>

                    <h4>Q: Why are some active clients not showing in my gaps?</h4>
                    <p><strong>A:</strong> Clients only appear if they have a billing gap exceeding your Look-back Days setting. If someone was billed within the last 30 days (default), they won't show in results.</p>

                    <h4>Q: What's the difference between "No Billing" and "Critical"?</h4>
                    <p><strong>A:</strong> "No Billing" (grey) means no billing record exists in your Billing Report file at all. "Critical" (red) means there IS a billing record, but it's more than 60 days old.</p>

                    <h4>Q: Can I change the 30/60 day thresholds?</h4>
                    <p><strong>A:</strong> Yes! Adjust "Look-back Days" and "Warning Threshold" in the controls or wizard. For example, use 14/30 for weekly billing cycles or 60/90 for quarterly reviews.</p>

                    <h4>Q: How often should I run this analysis?</h4>
                    <p><strong>A:</strong> Recommended weekly, ideally the same day each week. This creates consistent tracking and allows you to spot trends over time.</p>

                    <h4>Q: What does the Fund column show?</h4>
                    <p><strong>A:</strong> The first 3 characters of the Funding field (e.g., "MED" for Medicaid, "COM" for Commercial). This helps quickly identify funding sources.</p>

                    <h4>Q: Can I save my filter settings?</h4>
                    <p><strong>A:</strong> Yes, use the Settings tab to export your configuration. You can import it later or share with colleagues for consistent analysis.</p>

                    <h4>Q: Why does the analysis take several seconds?</h4>
                    <p><strong>A:</strong> The tool processes every active client against every billing record, calculates fuzzy matches, and performs gap analysis. Large datasets (1000+ clients) may take 10-30 seconds.</p>

                    <h4>Q: What's included in the Excel export?</h4>
                    <p><strong>A:</strong> Four sheets: (1) Complete gap data, (2) Summary statistics, (3) Provider analysis with gap counts per provider, (4) Service type breakdown with averages.</p>

                    <h4>Q: Can I use this tool offline?</h4>
                    <p><strong>A:</strong> Yes! Save this HTML file to your computer. All processing happens in your browser - no internet required except for downloading FOCUS reports initially.</p>

                    <h4>Q: What browsers are supported?</h4>
                    <p><strong>A:</strong> Modern versions of Chrome, Firefox, Edge, and Safari. For best performance, use Chrome or Edge. Internet Explorer is not supported.</p>

                    <h4>Q: How do I interpret the Provider Performance chart?</h4>
                    <p><strong>A:</strong> Shows top 10 providers by number of clients with gaps. Higher bars indicate more gaps. Use this to identify providers who may need billing training or support.</p>

                    <h4>Q: What if I find an error in the results?</h4>
                    <p><strong>A:</strong> First, verify source data in FOCUS. Then check your MAID matching (enable fuzzy matching if needed). Finally, verify Look-back Days settings are appropriate for your workflow.</p>
                </div>

                <div class="help-section">
                    <h3>Need More Help?</h3>
                    <p>For additional support:</p>
                    <ul>
                        <li>Use the <strong>Setup Wizard</strong> for step-by-step guidance</li>
                        <li>Check the <strong>Settings</strong> tab for configuration options</li>
                        <li>Review example data by clicking "Load Sample" in the quick menu</li>
                        <li>Contact your FOCUS EHR administrator for report access issues</li>
                    </ul>
                    
                    <div class="tip">
                        <strong>Pro Tip:</strong> Bookmark this page and check back after FOCUS EHR updates for any new features or improvements to the analysis tool.
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>© 2025 Accelerate Solutions, LLC</strong></p>
            <p class="version-info">Build Date: October 5, 2025 | Version 3.0 Professional Edition</p>
            <p class="version-info">FOCUS EHR Integration | Advanced Billing Gap Analysis Suite</p>
        </div>
    </div>

    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <div class="fab-option" onclick="showHelp()">Help & Docs</div>
            <div class="fab-option" onclick="clearData()">Clear All Data</div>
            <div class="fab-option" onclick="loadSampleData()">Load Sample Data</div>
            <div class="fab-option" onclick="downloadTemplate()">Download Template</div>
        </div>
        <button class="fab" onclick="toggleFabMenu()">+</button>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Quick Reference Guide</h2>
                <button class="close-modal" onclick="closeHelp()">&times;</button>
            </div>
            
            <div class="help-section">
                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li><code>Ctrl + F</code> - Focus search box</li>
                    <li><code>Ctrl + E</code> - Export to Excel</li>
                    <li><code>Ctrl + R</code> - Refresh data</li>
                    <li><code>Esc</code> - Close modals</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>Quick Tips</h3>
                <ul>
                    <li>Click column headers to sort data</li>
                    <li>Use filters to focus on specific providers or services</li>
                    <li>Export regularly to track improvement over time</li>
                    <li>Check Analytics tab for visual insights</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>For Complete Documentation</h3>
                <p>Visit the <strong>Instructions</strong> tab for the full user guide, troubleshooting help, and best practices.</p>
            </div>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">🌙</button>

    <script>
        let activeData = null;
        let billingData = null;
        let paData = null;
        let gapData = [];
        let filteredData = [];
        let sortDirection = {};
        let isDarkMode = false;
        let chartInstances = {};
        let activeQuickFilters = {
            severity: null,
            days: null,
            pa: null
        };
        let visibleColumns = {
            name: true,
            fund: true,
            provider: true,
            service: true,
            lastBill: true,
            daysSince: true,
            status: true,
            paStatus: true,
            paTypes: true,
            paExpires: true
        };

        const DEFAULT_SETTINGS = {
            lookbackDays: 30,
            warnDays: 60,
            showEmojis: true,
            compactView: false,
            autoRefresh: false,
            enableFuzzyMatch: true,
            excludeHRFunding: true,
            fuzzyThreshold: 80,
            includeCharts: true,
            includeSummary: true,
            exportFormat: 'xlsx',
            showAlerts: true,
            alertDuration: 5
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            initializeColumnSelector();
            
            const hasVisited = localStorage.getItem('focusEHRVisited');
            if (!hasVisited) {
                showStatus('info', 'Welcome to FOCUS EHR Analytics v3.0! Visit the Setup Wizard or Instructions tab to get started.');
                localStorage.setItem('focusEHRVisited', 'true');
            }

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                } else if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportToExcel();
                } else if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    refreshData();
                } else if (e.key === 'Escape') {
                    closeHelp();
                }
            });
        });

        function loadSettings() {
            const saved = localStorage.getItem('focusEHRSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                Object.keys(settings).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = settings[key];
                        } else {
                            el.value = settings[key];
                        }
                    }
                });
            }
        }

        function saveSettings() {
            const settings = {};
            Object.keys(DEFAULT_SETTINGS).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    settings[key] = el.type === 'checkbox' ? el.checked : el.value;
                }
            });
            localStorage.setItem('focusEHRSettings', JSON.stringify(settings));
            showStatus('success', 'Settings saved');
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                localStorage.removeItem('focusEHRSettings');
                Object.keys(DEFAULT_SETTINGS).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox') {
                            el.checked = DEFAULT_SETTINGS[key];
                        } else {
                            el.value = DEFAULT_SETTINGS[key];
                        }
                    }
                });
                showStatus('success', 'Settings reset to defaults');
            }
        }

        function exportSettings() {
            const settings = localStorage.getItem('focusEHRSettings') || JSON.stringify(DEFAULT_SETTINGS);
            const blob = new Blob([settings], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'focus_ehr_settings.json';
            a.click();
            showStatus('success', 'Settings exported');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const settings = JSON.parse(event.target.result);
                        localStorage.setItem('focusEHRSettings', JSON.stringify(settings));
                        loadSettings();
                        showStatus('success', 'Settings imported successfully');
                    } catch (error) {
                        showStatus('error', 'Invalid settings file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function handleActiveFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file, 'active');
            }
        }

        function handleBillingFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file, 'billing');
            }
        }

        function handlePAFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file, 'pa');
            }
        }

        function processFile(file, type) {
            showStatus('info', `Loading ${type} file...`);
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (type === 'active') {
                        activeData = jsonData;
                        showStatus('success', `Loaded ${activeData.length} active clients`);
                    } else if (type === 'billing') {
                        billingData = jsonData;
                        showStatus('success', `Loaded ${billingData.length} billing records`);
                    } else if (type === 'pa') {
                        paData = jsonData;
                        processPAData();
                        showStatus('success', `Loaded ${paData.length} PA records`);
                    }
                } catch (error) {
                    showStatus('error', `Error reading ${type} file: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function analyzeGaps() {
            if (!activeData || !billingData) {
                showStatus('error', 'Please upload both active clients and billing report files');
                return;
            }

            document.getElementById('spinner').style.display = 'block';
            showStatus('info', 'Analyzing billing gaps...');

            setTimeout(() => {
                performAnalysis();
                document.getElementById('spinner').style.display = 'none';
            }, 100);
        }

        function performAnalysis() {
            const lookbackDays = parseInt(document.getElementById('lookbackDays').value);
            const warnDays = parseInt(document.getElementById('warnDays').value);
            const excludeHR = document.getElementById('excludeHRFunding').checked;
            const today = new Date();

            const activeClients = activeData.filter(client => {
                return client.Status && 
                       client.Status.toLowerCase() === 'active' && 
                       (!excludeHR || !client.Funding || !client.Funding.includes('HR'));
            });

            const billingMap = {};
            billingData.forEach(bill => {
                const maid = bill.MAID ? bill.MAID.toString().trim() : '';
                const beginDate = bill['Begin Date'] ? new Date(bill['Begin Date']) : null;
                
                if (maid && beginDate) {
                    if (!billingMap[maid] || beginDate > billingMap[maid].date) {
                        billingMap[maid] = {
                            date: beginDate,
                            provider: bill['Created By'] || 'Unknown',
                            service: extractService(bill.Title || bill.title || ''),
                            fullName: bill.FullName || ''
                        };
                    }
                }
            });

            // Build PA lookup map
            const paMap = buildPAMap();

            gapData = [];
            const fuzzyEnabled = document.getElementById('enableFuzzyMatch').checked;
            const fuzzyThreshold = parseInt(document.getElementById('fuzzyThreshold').value) / 100;

            activeClients.forEach(client => {
                const maid = client.MAID ? client.MAID.toString().trim() : '';
                let billing = billingMap[maid];
                
                let daysSince = 0;
                let lastBillDate = null;
                let provider = 'No billing';
                let service = '—';
                
                if (billing) {
                    daysSince = Math.floor((today - billing.date) / (1000 * 60 * 60 * 24));
                    lastBillDate = billing.date;
                    provider = billing.provider;
                    service = billing.service;
                } else if (fuzzyEnabled) {
                    const clientName = (client.Name || '').toLowerCase();
                    if (clientName) {
                        Object.values(billingMap).forEach(bill => {
                            const billName = (bill.fullName || '').toLowerCase();
                            if (billName && fuzzyMatch(clientName, billName) > fuzzyThreshold) {
                                daysSince = Math.floor((today - bill.date) / (1000 * 60 * 60 * 24));
                                lastBillDate = bill.date;
                                provider = bill.provider;
                                service = bill.service;
                            }
                        });
                    }
                }

                if (daysSince === 0 || daysSince > lookbackDays) {
                    let tier, status;
                    if (daysSince === 0) {
                        tier = 'grey';
                        status = 'No Billing Record';
                    } else if (daysSince > warnDays) {
                        tier = 'red';
                        status = `Critical: ${daysSince} Days`;
                    } else {
                        tier = 'orange';
                        status = `Warning: ${daysSince} Days`;
                    }

                    // Get PA info for this client
                    const clientName = client.Name || '';
                    const paInfo = paMap[clientName] || {
                        hasValidPA: false,
                        validCount: 0,
                        expiredCount: 0,
                        validCategories: [],
                        expiredCategories: [],
                        allCategories: [],
                        nearestExpiration: null,
                        allExpirations: []
                    };

                    // Build comprehensive PA display strings
                    let paTypesDisplay = '—';
                    if (paInfo.validCategories.length > 0 || paInfo.expiredCategories.length > 0) {
                        paTypesDisplay = '<div>';
                        
                        if (paInfo.validCategories.length > 0) {
                            paTypesDisplay += paInfo.validCategories.map(cat => 
                                `<span class="pa-category-item pa-category-valid">✓ ${cat}</span>`
                            ).join('');
                        }
                        
                        if (paInfo.expiredCategories.length > 0) {
                            paTypesDisplay += paInfo.expiredCategories.map(cat => 
                                `<span class="pa-category-item pa-category-expired">✗ ${cat}</span>`
                            ).join('');
                        }
                        
                        paTypesDisplay += '</div>';
                    }

                    let paExpiresDisplay = '—';
                    if (paInfo.allExpirations.length > 0) {
                        paExpiresDisplay = '<div class="pa-expiration-list">';
                        paInfo.allExpirations.forEach(exp => {
                            const statusClass = exp.status === 'VALID' ? 'pa-expiration-valid' : 'pa-expiration-expired';
                            const statusIcon = exp.status === 'VALID' ? '✓' : '✗';
                            paExpiresDisplay += `
                                <div class="pa-expiration-item ${statusClass}">
                                    <span class="pa-expiration-icon">${statusIcon}</span>
                                    <span class="pa-expiration-category">${exp.category}</span>
                                    <span class="pa-expiration-date">${formatDate(exp.date)}</span>
                                </div>
                            `;
                        });
                        paExpiresDisplay += '</div>';
                    }

                    gapData.push({
                        name: client.Name || '',
                        fund: (client.Funding || '').substring(0, 3).toUpperCase(),
                        provider: provider,
                        service: service,
                        lastBill: lastBillDate ? formatDate(lastBillDate) : 'Never',
                        daysSince: daysSince || 0,
                        status: status,
                        tier: tier,
                        paStatus: paInfo.hasValidPA ? 'Valid' : (paInfo.expiredCount > 0 ? 'Expired' : 'None'),
                        paTypes: paTypesDisplay,
                        paExpires: paExpiresDisplay,
                        paValidCount: paInfo.validCount,
                        paExpiredCount: paInfo.expiredCount,
                        paAllExpirations: paInfo.allExpirations
                    });
                }
            });

            gapData.sort((a, b) => b.daysSince - a.daysSince);
            filteredData = [...gapData];
            populateFilterDropdowns();
            applyQuickFilters(); // Apply any active quick filters
            displayResults();
            if (gapData.length > 0) {
                updateAnalytics();
                document.getElementById('quickFilters').style.display = 'block';
                if (paData && paData.length > 0) {
                    document.getElementById('paQuickFilters').style.display = 'block';
                }
            }
            showStatus('success', `Found ${gapData.length} billing gaps`);
        }

        function toggleQuickFilter(type, value) {
            // Toggle the filter
            if (activeQuickFilters[type] === value) {
                activeQuickFilters[type] = null;
            } else {
                activeQuickFilters[type] = value;
            }
            
            updateQuickFilterUI();
            applyQuickFilters();
            displayResults();
        }

        function clearAllQuickFilters() {
            activeQuickFilters = {
                severity: null,
                days: null,
                pa: null
            };
            updateQuickFilterUI();
            filteredData = [...gapData];
            displayResults();
        }

        function updateQuickFilterUI() {
            // Remove all active classes
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Add active class to selected filters
            let activeCount = 0;
            
            if (activeQuickFilters.severity) {
                activeCount++;
                const severityBtn = document.querySelector(`.quick-filter-btn[onclick*="'severity', '${activeQuickFilters.severity}'"]`);
                if (severityBtn) severityBtn.classList.add('active');
            }
            
            if (activeQuickFilters.days) {
                activeCount++;
                const daysBtn = document.querySelector(`.quick-filter-btn[onclick*="'days', '${activeQuickFilters.days}'"]`);
                if (daysBtn) daysBtn.classList.add('active');
            }
            
            if (activeQuickFilters.pa) {
                activeCount++;
                const paBtn = document.querySelector(`.quick-filter-btn[onclick*="'pa', '${activeQuickFilters.pa}'"]`);
                if (paBtn) paBtn.classList.add('active');
            }

            // Update active filter count
            const countEl = document.getElementById('activeFilterCount');
            if (activeCount > 0) {
                countEl.textContent = `${activeCount} filter${activeCount > 1 ? 's' : ''} active`;
            } else {
                countEl.textContent = '';
            }
        }

        function applyQuickFilters() {
            filteredData = [...gapData];

            // Apply severity filter
            if (activeQuickFilters.severity) {
                filteredData = filteredData.filter(row => row.tier === activeQuickFilters.severity);
            }

            // Apply days filter
            if (activeQuickFilters.days) {
                const days = activeQuickFilters.days;
                if (days === '30-60') {
                    filteredData = filteredData.filter(row => row.daysSince >= 31 && row.daysSince <= 60);
                } else if (days === '60-90') {
                    filteredData = filteredData.filter(row => row.daysSince >= 61 && row.daysSince <= 90);
                } else if (days === '90-120') {
                    filteredData = filteredData.filter(row => row.daysSince >= 91 && row.daysSince <= 120);
                } else if (days === '120+') {
                    filteredData = filteredData.filter(row => row.daysSince > 120);
                }
            }

            // Apply PA filter
            if (activeQuickFilters.pa) {
                const paFilter = activeQuickFilters.pa;
                if (paFilter === 'valid') {
                    filteredData = filteredData.filter(row => row.paStatus === 'Valid' && row.paValidCount > 0);
                } else if (paFilter === 'expired') {
                    filteredData = filteredData.filter(row => row.paStatus === 'Expired');
                } else if (paFilter === 'expiring') {
                    // Check if any PA expires within 30 days
                    const thirtyDaysFromNow = new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000);
                    filteredData = filteredData.filter(row => {
                        if (row.paAllExpirations && row.paAllExpirations.length > 0) {
                            return row.paAllExpirations.some(exp => 
                                exp.status === 'VALID' && exp.date <= thirtyDaysFromNow && exp.date >= new Date()
                            );
                        }
                        return false;
                    });
                } else if (paFilter === 'none') {
                    filteredData = filteredData.filter(row => row.paStatus === 'None');
                }
            }
        }

        function buildPAMap() {
            const paMap = {};
            if (!paData) return paMap;

            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            paData.forEach(pa => {
                const name = pa.Name || '';
                const statusText = (pa.Status || '').toUpperCase();
                const expiresOn = parseExcelDate(pa.ExpiresOn);
                const category = pa.Category || '';

                if (!paMap[name]) {
                    paMap[name] = {
                        hasValidPA: false,
                        validCount: 0,
                        expiredCount: 0,
                        validCategories: [],
                        expiredCategories: [],
                        allCategories: [],
                        nearestExpiration: null,
                        allExpirations: [],
                        allPAs: []
                    };
                }

                // Determine if PA is valid - check for multiple status variations
                const isValid = statusText === 'VALID' || 
                               statusText.includes('EXPIRES') || 
                               (expiresOn && expiresOn > today);
                
                const isExpired = statusText === 'EXPIRED' || 
                                 (expiresOn && expiresOn <= today);

                if (isValid && !isExpired) {
                    paMap[name].hasValidPA = true;
                    paMap[name].validCount++;
                    
                    if (category) {
                        if (!paMap[name].validCategories.includes(category)) {
                            paMap[name].validCategories.push(category);
                        }
                        if (!paMap[name].allCategories.includes(category)) {
                            paMap[name].allCategories.push(category);
                        }
                    }

                    if (expiresOn) {
                        if (!paMap[name].nearestExpiration || expiresOn < paMap[name].nearestExpiration) {
                            paMap[name].nearestExpiration = expiresOn;
                        }
                        paMap[name].allExpirations.push({
                            category: category,
                            date: expiresOn,
                            status: 'VALID'
                        });
                    }
                } else {
                    paMap[name].expiredCount++;
                    if (category) {
                        if (!paMap[name].expiredCategories.includes(category)) {
                            paMap[name].expiredCategories.push(category);
                        }
                        if (!paMap[name].allCategories.includes(category)) {
                            paMap[name].allCategories.push(category);
                        }
                    }
                    if (expiresOn) {
                        paMap[name].allExpirations.push({
                            category: category,
                            date: expiresOn,
                            status: 'EXPIRED'
                        });
                    }
                }

                paMap[name].allPAs.push({
                    category: category,
                    status: statusText,
                    expiresOn: expiresOn,
                    fundingSource: pa.FundingSource || '',
                    approved: pa.Approved || ''
                });
            });

            // Sort expirations by date (soonest first)
            Object.values(paMap).forEach(client => {
                client.allExpirations.sort((a, b) => a.date - b.date);
            });

            return paMap;
        }

        function parseExcelDate(value) {
            if (!value) return null;
            
            // If it's already a Date object
            if (value instanceof Date) {
                return value;
            }
            
            // If it's a number (Excel serial date)
            if (typeof value === 'number') {
                // Excel dates are days since 1900-01-01 (with a leap year bug)
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + value * 86400000);
            }
            
            // If it's a string, try to parse it
            if (typeof value === 'string') {
                // Try MM/DD/YYYY format
                const parts = value.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]) - 1; // JS months are 0-indexed
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    return new Date(year, month, day);
                }
                
                // Fall back to standard parsing
                const parsed = new Date(value);
                if (!isNaN(parsed.getTime())) {
                    return parsed;
                }
            }
            
            return null;
        }

        function processPAData() {
            if (!paData || paData.length === 0) {
                return;
            }

            displayPATracker();
            updatePAAnalytics();
            document.getElementById('paInfoBanner').style.display = 'flex';
            
            // Show PA quick filters if gap data exists
            if (gapData.length > 0) {
                document.getElementById('paQuickFilters').style.display = 'block';
            }
        }

        function displayPATracker() {
            const tbody = document.getElementById('paTableBody');
            tbody.innerHTML = '';

            if (!paData || paData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Upload a PA file to view authorization status</td></tr>`;
                return;
            }

            // Group PAs by client name
            const clientPAs = {};
            paData.forEach(pa => {
                const name = pa.Name || '';
                if (!clientPAs[name]) {
                    clientPAs[name] = [];
                }
                clientPAs[name].push(pa);
            });

            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            // Populate filters
            const categories = new Set();
            const fundingSources = new Set();
            paData.forEach(pa => {
                if (pa.Category) categories.add(pa.Category);
                if (pa.FundingSource) fundingSources.add(pa.FundingSource);
            });

            const categoryFilter = document.getElementById('paCategoryFilter');
            const fundingFilter = document.getElementById('paFundingFilter');
            
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            fundingFilter.innerHTML = '<option value="all">All Funding Sources</option>';

            [...categories].sort().forEach(cat => {
                categoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
            });

            [...fundingSources].sort().forEach(fund => {
                fundingFilter.innerHTML += `<option value="${fund}">${fund}</option>`;
            });

            // Create rows for each client
            Object.entries(clientPAs).forEach(([name, pas]) => {
                const today = new Date();
                
                // Improved PA status detection
                const validPAs = pas.filter(p => {
                    const statusText = (p.Status || '').toUpperCase();
                    const expDate = parseExcelDate(p.ExpiresOn);
                    return statusText === 'VALID' || 
                           statusText.includes('EXPIRES') || 
                           (expDate && expDate > today);
                });
                
                const expiredPAs = pas.filter(p => {
                    const statusText = (p.Status || '').toUpperCase();
                    const expDate = parseExcelDate(p.ExpiresOn);
                    return statusText === 'EXPIRED' || 
                           (expDate && expDate <= today && !statusText.includes('EXPIRES'));
                });
                
                // Get all categories with styled badges
                const validCategories = [...new Set(validPAs.map(p => p.Category))].filter(Boolean);
                const expiredCategories = [...new Set(expiredPAs.map(p => p.Category))].filter(Boolean);
                
                let categoriesDisplay = '<div style="min-width: 200px;">';
                if (validCategories.length > 0) {
                    categoriesDisplay += '<div class="pa-section-header" style="color: #27ae60;">Active</div>';
                    categoriesDisplay += validCategories.map(cat => 
                        `<span class="pa-category-item pa-category-valid">✓ ${cat}</span>`
                    ).join('');
                }
                if (expiredCategories.length > 0) {
                    categoriesDisplay += '<div class="pa-section-header" style="color: #e74c3c; margin-top: 8px;">Expired</div>';
                    categoriesDisplay += expiredCategories.map(cat => 
                        `<span class="pa-category-item pa-category-expired">✗ ${cat}</span>`
                    ).join('');
                }
                if (validCategories.length === 0 && expiredCategories.length === 0) {
                    categoriesDisplay = '—';
                } else {
                    categoriesDisplay += '</div>';
                }
                
                // Get all expirations with styled list
                let allExpirations = [];
                let nearestExpiration = null;
                let expiringWithin30Days = false;

                [...validPAs, ...expiredPAs].forEach(pa => {
                    if (pa.ExpiresOn) {
                        const expDate = parseExcelDate(pa.ExpiresOn);
                        if (expDate) {
                            allExpirations.push({
                                category: pa.Category || 'Unknown',
                                date: expDate,
                                status: pa.Status,
                                fundingSource: pa.FundingSource || ''
                            });
                            
                            if (pa.Status && pa.Status.toUpperCase() === 'VALID') {
                                if (!nearestExpiration || expDate < nearestExpiration) {
                                    nearestExpiration = expDate;
                                }
                                if (expDate <= thirtyDaysFromNow && expDate >= today) {
                                    expiringWithin30Days = true;
                                }
                            }
                        }
                    }
                });

                // Sort expirations by date
                allExpirations.sort((a, b) => a.date - b.date);

                // Build comprehensive expiration display with new styling
                let expirationDisplay = '—';
                if (allExpirations.length > 0) {
                    expirationDisplay = '<div class="pa-expiration-list" style="min-width: 220px;">';
                    allExpirations.forEach(exp => {
                        const statusClass = exp.status && exp.status.toUpperCase() === 'VALID' ? 'pa-expiration-valid' : 'pa-expiration-expired';
                        const statusIcon = exp.status && exp.status.toUpperCase() === 'VALID' ? '✓' : '✗';
                        expirationDisplay += `
                            <div class="pa-expiration-item ${statusClass}">
                                <span class="pa-expiration-icon">${statusIcon}</span>
                                <span class="pa-expiration-category">${exp.category}</span>
                                <span class="pa-expiration-date">${formatDate(exp.date)}</span>
                            </div>
                        `;
                    });
                    expirationDisplay += '</div>';
                }

                const tr = document.createElement('tr');
                let paStatusBadge = '';
                
                if (validPAs.length > 0) {
                    if (expiringWithin30Days) {
                        paStatusBadge = `<span class="badge badge-warning">⚠️ Expiring Soon (${validPAs.length})</span>`;
                        tr.className = 'tier-orange';
                    } else {
                        paStatusBadge = `<span class="badge" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white;">✅ Valid (${validPAs.length})</span>`;
                    }
                } else if (expiredPAs.length > 0) {
                    paStatusBadge = `<span class="badge badge-critical">❌ Expired (${expiredPAs.length})</span>`;
                    tr.className = 'tier-red';
                } else {
                    paStatusBadge = '<span class="badge badge-none">⚪ No PA</span>';
                    tr.className = 'tier-grey';
                }

                tr.innerHTML = `
                    <td>${name}</td>
                    <td>${paStatusBadge}</td>
                    <td style="text-align: center;"><strong style="font-size: 1.2em;">${validPAs.length}</strong></td>
                    <td style="text-align: center;"><strong style="font-size: 1.2em;">${expiredPAs.length}</strong></td>
                    <td class="pa-info-cell">${categoriesDisplay}</td>
                    <td class="pa-info-cell">${expirationDisplay}</td>
                    <td style="text-align: center;">
                        <button class="btn btn-sm" onclick="viewPADetails('${name.replace(/'/g, "\\'")}')">View Details</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });

            document.getElementById('paRowCount').textContent = `Showing ${Object.keys(clientPAs).length} clients`;
        }

        function updatePAAnalytics() {
            if (!paData || paData.length === 0) return;

            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            const validCount = paData.filter(p => p.Status && p.Status.toUpperCase() === 'VALID').length;
            const expiredCount = paData.filter(p => p.Status && p.Status.toUpperCase() === 'EXPIRED').length;
            
            let expiringSoonCount = 0;
            paData.forEach(pa => {
                if (pa.Status && pa.Status.toUpperCase() === 'VALID' && pa.ExpiresOn) {
                    const expDate = parseExcelDate(pa.ExpiresOn);
                    if (expDate && expDate <= thirtyDaysFromNow && expDate >= today) {
                        expiringSoonCount++;
                    }
                }
            });

            const categories = new Set(paData.map(p => p.Category).filter(Boolean));
            const clients = new Set(paData.map(p => p.Name).filter(Boolean));

            document.getElementById('paValidCount').textContent = validCount;
            document.getElementById('paExpiredCount').textContent = expiredCount;
            document.getElementById('paExpiringSoonCount').textContent = expiringSoonCount;
            document.getElementById('paTotalAuths').textContent = paData.length;
            document.getElementById('paUniqueCategories').textContent = categories.size;
            document.getElementById('paClientsWithPA').textContent = clients.size;

            // Show charts
            document.getElementById('paChartsContainer').style.display = 'block';
            document.getElementById('paCategoryChartContainer').style.display = 'block';

            // Create PA status chart
            if (chartInstances.paStatus) {
                chartInstances.paStatus.destroy();
            }

            const paStatusCtx = document.getElementById('paStatusChart').getContext('2d');
            chartInstances.paStatus = new Chart(paStatusCtx, {
                type: 'pie',
                data: {
                    labels: ['Valid', 'Expired', 'Expiring Soon'],
                    datasets: [{
                        data: [validCount - expiringSoonCount, expiredCount, expiringSoonCount],
                        backgroundColor: ['#27ae60', '#e74c3c', '#f39c12'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            // Create category chart
            const categoryCounts = {};
            paData.forEach(pa => {
                if (pa.Category) {
                    categoryCounts[pa.Category] = (categoryCounts[pa.Category] || 0) + 1;
                }
            });

            if (chartInstances.paCategory) {
                chartInstances.paCategory.destroy();
            }

            const paCategoryCtx = document.getElementById('paCategoryChart').getContext('2d');
            chartInstances.paCategory = new Chart(paCategoryCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        label: 'Number of Authorizations',
                        data: Object.values(categoryCounts),
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function viewClientDetails(clientName) {
            // Get the client's gap data
            const client = gapData.find(g => g.name === clientName);
            if (!client) {
                alert('No data found for ' + clientName);
                return;
            }

            // Find the matching active client for MAID
            const activeClient = activeData ? activeData.find(a => a.Name === clientName) : null;
            const maid = activeClient ? activeClient.MAID : 'N/A';

            // Get all billing records for this client
            const clientBilling = [];
            if (billingData && activeClient) {
                billingData.forEach(bill => {
                    const billMAID = bill.MAID ? bill.MAID.toString().trim() : '';
                    const clientMAID = activeClient.MAID ? activeClient.MAID.toString().trim() : '';
                    if (billMAID === clientMAID) {
                        clientBilling.push(bill);
                    }
                });
            }

            // Sort billing by date descending
            clientBilling.sort((a, b) => {
                const dateA = a['Begin Date'] ? new Date(a['Begin Date']) : new Date(0);
                const dateB = b['Begin Date'] ? new Date(b['Begin Date']) : new Date(0);
                return dateB - dateA;
            });

            // Get PA data for this client
            const clientPAs = paData ? paData.filter(pa => pa.Name === clientName) : [];

            // Build the details HTML
            let detailsHTML = '<div class="detail-modal">';

            // Summary Section
            detailsHTML += '<div class="detail-section">';
            detailsHTML += `<h3>Client Summary</h3>`;
            detailsHTML += '<div class="detail-grid">';
            detailsHTML += `
                <div class="detail-item">
                    <div class="detail-item-label">Client Name</div>
                    <div class="detail-item-value">${client.name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-item-label">MAID</div>
                    <div class="detail-item-value">${maid}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-item-label">Funding Source</div>
                    <div class="detail-item-value">${client.fund}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-item-label">Days Since Last Bill</div>
                    <div class="detail-item-value" style="color: ${client.tier === 'red' ? 'var(--danger)' : client.tier === 'orange' ? 'var(--warning)' : '#999'};">${client.daysSince}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-item-label">Last Bill Date</div>
                    <div class="detail-item-value">${client.lastBill}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-item-label">Status</div>
                    <div class="detail-item-value">${client.status}</div>
                </div>
            `;
            detailsHTML += '</div></div>';

            // Billing History Section
            detailsHTML += '<div class="detail-section">';
            detailsHTML += `<h3>Billing History (${clientBilling.length} Records)</h3>`;
            if (clientBilling.length > 0) {
                detailsHTML += '<table class="billing-history-table">';
                detailsHTML += `<tr>
                    <th>Begin Date</th>
                    <th>End Date</th>
                    <th>Service/Title</th>
                    <th>Provider</th>
                    <th>Days Ago</th>
                    <th>Days Since Last Bill</th>
                </tr>`;

                const today = new Date();
                clientBilling.forEach((bill, index) => {
                    const beginDate = bill['Begin Date'] ? new Date(bill['Begin Date']) : null;
                    const endDate = bill['End Date'] ? new Date(bill['End Date']) : null;
                    const daysAgo = beginDate ? Math.floor((today - beginDate) / (1000 * 60 * 60 * 24)) : 'N/A';

                    // Calculate days since previous billing record
                    let daysSinceLastBill = '—';
                    let gapColor = '#666';
                    if (index > 0 && beginDate) {
                        const previousBill = clientBilling[index - 1];
                        const previousBeginDate = previousBill['Begin Date'] ? new Date(previousBill['Begin Date']) : null;
                        if (previousBeginDate) {
                            const daysDiff = Math.floor((previousBeginDate - beginDate) / (1000 * 60 * 60 * 24));
                            daysSinceLastBill = daysDiff;

                            // Color code based on gap size
                            if (daysDiff > 60) {
                                gapColor = 'var(--danger)';
                            } else if (daysDiff > 30) {
                                gapColor = 'var(--warning)';
                            } else {
                                gapColor = 'var(--success)';
                            }
                        }
                    } else if (index === 0) {
                        daysSinceLastBill = 'Most Recent';
                        gapColor = 'var(--info)';
                    }

                    detailsHTML += `<tr>
                        <td><strong>${beginDate ? formatDate(beginDate) : 'N/A'}</strong></td>
                        <td>${endDate ? formatDate(endDate) : 'N/A'}</td>
                        <td>${bill.Title || bill.title || '—'}</td>
                        <td>${bill['Created By'] || 'Unknown'}</td>
                        <td>${daysAgo}</td>
                        <td style="color: ${gapColor}; font-weight: bold;">${daysSinceLastBill}</td>
                    </tr>`;
                });

                detailsHTML += '</table>';
            } else {
                detailsHTML += '<div class="no-data">No billing records found for this client</div>';
            }
            detailsHTML += '</div>';

            // PA Authorization Section
            if (paData && paData.length > 0) {
                detailsHTML += '<div class="detail-section">';
                detailsHTML += `<h3>Prior Authorizations (${clientPAs.length} Records)</h3>`;

                if (clientPAs.length > 0) {
                    detailsHTML += '<table class="billing-history-table">';
                    detailsHTML += `<tr>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Funding Source</th>
                        <th>Expires On</th>
                        <th>Days Until Expiry</th>
                        <th>Approved</th>
                    </tr>`;

                    const today = new Date();
                    clientPAs.forEach(pa => {
                        const statusColor = pa.Status && pa.Status.toUpperCase() === 'VALID' ? '#27ae60' : '#e74c3c';
                        const expDate = parseExcelDate(pa.ExpiresOn);
                        const daysUntilExpiry = expDate ? Math.floor((expDate - today) / (1000 * 60 * 60 * 24)) : null;
                        let expiryDisplay = 'N/A';
                        let expiryColor = '#666';

                        if (daysUntilExpiry !== null) {
                            if (daysUntilExpiry < 0) {
                                expiryDisplay = `Expired ${Math.abs(daysUntilExpiry)} days ago`;
                                expiryColor = 'var(--danger)';
                            } else if (daysUntilExpiry <= 30) {
                                expiryDisplay = `${daysUntilExpiry} days`;
                                expiryColor = 'var(--warning)';
                            } else {
                                expiryDisplay = `${daysUntilExpiry} days`;
                                expiryColor = 'var(--success)';
                            }
                        }

                        detailsHTML += `<tr>
                            <td><strong>${pa.Category || '—'}</strong></td>
                            <td style="color: ${statusColor}; font-weight: bold;">${pa.Status || '—'}</td>
                            <td>${pa.FundingSource || '—'}</td>
                            <td>${expDate ? formatDate(expDate) : '—'}</td>
                            <td style="color: ${expiryColor}; font-weight: bold;">${expiryDisplay}</td>
                            <td>${pa.Approved || '—'}</td>
                        </tr>`;
                    });

                    detailsHTML += '</table>';
                } else {
                    detailsHTML += '<div class="no-data">No prior authorizations found for this client</div>';
                }
                detailsHTML += '</div>';
            }

            detailsHTML += '</div>';

            // Create and display modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content detail-modal">
                    <div class="modal-header">
                        <h2>Comprehensive Client Details: ${clientName}</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${detailsHTML}
                </div>
            `;
            document.body.appendChild(modal);

            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }

        function viewPADetails(clientName) {
            if (!paData) return;

            const clientPAs = paData.filter(pa => pa.Name === clientName);
            if (clientPAs.length === 0) {
                alert('No PA data found for ' + clientName);
                return;
            }

            let detailsHTML = `<h3>PA Details for ${clientName}</h3><table style="width: 100%; margin-top: 20px; border-collapse: collapse;">`;
            detailsHTML += `<tr style="background: var(--bg-gradient); color: white;">
                <th style="padding: 10px; text-align: left;">Category</th>
                <th style="padding: 10px; text-align: left;">Status</th>
                <th style="padding: 10px; text-align: left;">Funding Source</th>
                <th style="padding: 10px; text-align: left;">Expires On</th>
                <th style="padding: 10px; text-align: left;">Approved</th>
            </tr>`;

            clientPAs.forEach(pa => {
                const statusColor = pa.Status && pa.Status.toUpperCase() === 'VALID' ? '#27ae60' : '#e74c3c';
                const expDate = parseExcelDate(pa.ExpiresOn);
                detailsHTML += `<tr style="border-bottom: 1px solid var(--light);">
                    <td style="padding: 10px;">${pa.Category || '—'}</td>
                    <td style="padding: 10px; color: ${statusColor}; font-weight: bold;">${pa.Status || '—'}</td>
                    <td style="padding: 10px;">${pa.FundingSource || '—'}</td>
                    <td style="padding: 10px;">${expDate ? formatDate(expDate) : '—'}</td>
                    <td style="padding: 10px;">${pa.Approved || '—'}</td>
                </tr>`;
            });

            detailsHTML += '</table>';

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Authorization Details</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${detailsHTML}
                </div>
            `;
            document.body.appendChild(modal);

            modal.onclick = function(event) {
                if (event.target === modal) {
                    modal.remove();
                }
            };
        }

        function togglePAFilters() {
            const el = document.getElementById('paFilterBar');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function filterPATable() {
            const searchValue = document.getElementById('paSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('paStatusFilter').value;
            const categoryFilter = document.getElementById('paCategoryFilter').value;
            const fundingFilter = document.getElementById('paFundingFilter').value;

            const tbody = document.getElementById('paTableBody');
            const rows = tbody.getElementsByTagName('tr');

            let visibleCount = 0;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length === 0) continue;

                const name = cells[0].textContent.toLowerCase();
                const paStatus = cells[1].textContent;
                
                let matchesSearch = name.includes(searchValue);
                let matchesStatus = statusFilter === 'all';
                
                if (statusFilter === 'valid' && paStatus.includes('Valid') && !paStatus.includes('Expiring')) {
                    matchesStatus = true;
                } else if (statusFilter === 'expired' && paStatus.includes('Expired')) {
                    matchesStatus = true;
                } else if (statusFilter === 'expiring' && paStatus.includes('Expiring')) {
                    matchesStatus = true;
                } else if (statusFilter === 'none' && paStatus.includes('No PA')) {
                    matchesStatus = true;
                }

                const categories = cells[4].textContent;
                let matchesCategory = categoryFilter === 'all' || categories.includes(categoryFilter);

                rows[i].style.display = matchesSearch && matchesStatus && matchesCategory ? '' : 'none';
                if (matchesSearch && matchesStatus && matchesCategory) visibleCount++;
            }

            document.getElementById('paRowCount').textContent = `Showing ${visibleCount} clients`;
        }

        function clearPAFilters() {
            document.getElementById('paStatusFilter').value = 'all';
            document.getElementById('paCategoryFilter').value = 'all';
            document.getElementById('paFundingFilter').value = 'all';
            document.getElementById('paSearchInput').value = '';
            filterPATable();
        }

        function sortPATable(columnIndex) {
            const table = document.getElementById('paTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            const dir = sortDirection['pa_' + columnIndex] || 'asc';
            sortDirection['pa_' + columnIndex] = dir === 'asc' ? 'desc' : 'asc';
            
            const headers = table.getElementsByTagName('th');
            for (let i = 0; i < headers.length; i++) {
                const indicator = headers[i].querySelector('.sort-indicator');
                if (indicator) {
                    if (i === columnIndex) {
                        indicator.textContent = dir === 'asc' ? '▲' : '▼';
                        indicator.className = 'sort-indicator ' + (dir === 'asc' ? '' : 'desc');
                    } else {
                        indicator.textContent = '▼';
                        indicator.className = 'sort-indicator';
                    }
                }
            }
            
            rows.sort((a, b) => {
                const aCells = a.getElementsByTagName('td');
                const bCells = b.getElementsByTagName('td');
                if (aCells.length === 0 || bCells.length === 0) return 0;
                
                const aValue = aCells[columnIndex].textContent.trim();
                const bValue = bCells[columnIndex].textContent.trim();
                
                if (columnIndex === 2 || columnIndex === 3) {
                    const aNum = parseInt(aValue) || 0;
                    const bNum = parseInt(bValue) || 0;
                    return dir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                if (columnIndex === 5) {
                    const aDate = aValue === '—' ? new Date(0) : new Date(aValue);
                    const bDate = bValue === '—' ? new Date(0) : new Date(bValue);
                    return dir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                if (dir === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function exportPAToExcel() {
            if (!paData || paData.length === 0) {
                showStatus('error', 'No PA data to export');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Group by client
            const clientPAs = {};
            paData.forEach(pa => {
                const name = pa.Name || '';
                if (!clientPAs[name]) {
                    clientPAs[name] = [];
                }
                clientPAs[name].push(pa);
            });

            const today = new Date();
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

            const summaryData = [];
            Object.entries(clientPAs).forEach(([name, pas]) => {
                const validPAs = pas.filter(p => p.Status && p.Status.toUpperCase() === 'VALID');
                const expiredPAs = pas.filter(p => p.Status && p.Status.toUpperCase() === 'EXPIRED');
                const categories = [...new Set(validPAs.map(p => p.Category))].filter(Boolean).join(', ');
                
                let nearestExpiration = null;
                validPAs.forEach(pa => {
                    if (pa.ExpiresOn) {
                        const expDate = parseExcelDate(pa.ExpiresOn);
                        if (expDate) {
                            if (!nearestExpiration || expDate < nearestExpiration) {
                                nearestExpiration = expDate;
                            }
                        }
                    }
                });

                summaryData.push({
                    'Client Name': name,
                    'Valid PAs': validPAs.length,
                    'Expired PAs': expiredPAs.length,
                    'Categories': categories || '—',
                    'Nearest Expiration': nearestExpiration ? formatDate(nearestExpiration) : '—'
                });
            });

            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            wsSummary['!cols'] = [{wch: 30}, {wch: 12}, {wch: 12}, {wch: 40}, {wch: 18}];
            XLSX.utils.book_append_sheet(wb, wsSummary, 'PA Summary');

            // All PAs sheet
            const allPAsData = paData.map(pa => {
                const expDate = parseExcelDate(pa.ExpiresOn);
                return {
                    'Client Name': pa.Name || '',
                    'Category': pa.Category || '',
                    'Status': pa.Status || '',
                    'Funding Source': pa.FundingSource || '',
                    'Expires On': expDate ? formatDate(expDate) : '',
                    'Approved': pa.Approved || '',
                    'Title': pa.Title || ''
                };
            });

            const wsAll = XLSX.utils.json_to_sheet(allPAsData);
            wsAll['!cols'] = [{wch: 30}, {wch: 25}, {wch: 10}, {wch: 30}, {wch: 15}, {wch: 10}, {wch: 40}];
            XLSX.utils.book_append_sheet(wb, wsAll, 'All Authorizations');

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const filename = `PA_Report_${timestamp}.xlsx`;

            XLSX.writeFile(wb, filename);
            showStatus('success', `PA report exported: ${filename}`);
        }

        function populateFilterDropdowns() {
            const providers = [...new Set(gapData.map(d => d.provider))].sort();
            const services = [...new Set(gapData.map(d => d.service))].sort();
            const funds = [...new Set(gapData.map(d => d.fund))].sort();

            const providerSelect = document.getElementById('providerFilter');
            const serviceSelect = document.getElementById('serviceFilter');
            const fundSelect = document.getElementById('fundFilter');

            providerSelect.innerHTML = '<option value="all">All Providers</option>';
            serviceSelect.innerHTML = '<option value="all">All Services</option>';
            fundSelect.innerHTML = '<option value="all">All Funds</option>';

            providers.forEach(p => {
                providerSelect.innerHTML += `<option value="${p}">${p}</option>`;
            });

            services.forEach(s => {
                serviceSelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            funds.forEach(f => {
                fundSelect.innerHTML += `<option value="${f}">${f}</option>`;
            });
        }

        function initializeColumnSelector() {
            const container = document.getElementById('columnCheckboxes');
            const columns = ['name', 'fund', 'provider', 'service', 'lastBill', 'daysSince', 'status', 'paStatus', 'paTypes', 'paExpires'];
            const labels = ['Name', 'Fund', 'Provider', 'Service', 'Last Bill', 'Days Since', 'Status', 'PA Status', 'All PA Types', 'All PA Expirations'];

            columns.forEach((col, i) => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.innerHTML = `
                    <input type="checkbox" id="col-${col}" ${visibleColumns[col] ? 'checked' : ''} onchange="toggleColumn('${col}')">
                    <label for="col-${col}">${labels[i]}</label>
                `;
                container.appendChild(div);
            });
        }

        function toggleColumn(column) {
            visibleColumns[column] = !visibleColumns[column];
            displayResults();
        }

        function toggleColumnSelector() {
            const el = document.getElementById('columnToggle');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function toggleFilters() {
            const el = document.getElementById('filterBar');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function applyFilters() {
            const tier = document.getElementById('tierFilter').value;
            const provider = document.getElementById('providerFilter').value;
            const service = document.getElementById('serviceFilter').value;
            const fund = document.getElementById('fundFilter').value;
            const minDays = parseInt(document.getElementById('minDaysFilter').value) || 0;
            const maxDays = parseInt(document.getElementById('maxDaysFilter').value) || Infinity;

            // Start with quick filters applied
            applyQuickFilters();

            // Then apply advanced filters on top
            filteredData = filteredData.filter(row => {
                return (tier === 'all' || row.tier === tier) &&
                       (provider === 'all' || row.provider === provider) &&
                       (service === 'all' || row.service === service) &&
                       (fund === 'all' || row.fund === fund) &&
                       (row.daysSince >= minDays && row.daysSince <= maxDays);
            });

            displayResults();
        }

        function clearFilters() {
            document.getElementById('tierFilter').value = 'all';
            document.getElementById('providerFilter').value = 'all';
            document.getElementById('serviceFilter').value = 'all';
            document.getElementById('fundFilter').value = 'all';
            document.getElementById('minDaysFilter').value = '';
            document.getElementById('maxDaysFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            // Also clear quick filters
            clearAllQuickFilters();
        }

        function displayResults() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const tableContainer = document.getElementById('tableContainer');
            const summaryBar = document.getElementById('summaryBar');
            
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (gapData.length === 0) {
                tableContainer.style.display = 'none';
                summaryBar.style.display = 'none';
                return;
            }

            tableContainer.style.display = 'block';
            summaryBar.style.display = 'flex';

            const hasPAData = paData && paData.length > 0;

            const columns = [
                {key: 'name', label: 'Name', visible: visibleColumns.name},
                {key: 'fund', label: 'Fund', visible: visibleColumns.fund},
                {key: 'provider', label: 'Provider', visible: visibleColumns.provider},
                {key: 'service', label: 'Service', visible: visibleColumns.service},
                {key: 'lastBill', label: 'Last Bill', visible: visibleColumns.lastBill},
                {key: 'daysSince', label: 'Days Since', visible: visibleColumns.daysSince},
                {key: 'status', label: 'Status', visible: visibleColumns.status},
                {key: 'paStatus', label: 'PA Status', visible: hasPAData && visibleColumns.paStatus},
                {key: 'paTypes', label: 'All PA Types', visible: hasPAData && visibleColumns.paTypes},
                {key: 'paExpires', label: 'All PA Expirations', visible: hasPAData && visibleColumns.paExpires}
            ];

            let colIndex = 0;
            columns.forEach(col => {
                if (col.visible) {
                    const th = document.createElement('th');
                    th.innerHTML = `${col.label} <span class="sort-indicator">▼</span>`;
                    th.onclick = () => sortTable(colIndex);
                    tableHeader.appendChild(th);
                    colIndex++;
                }
            });

            const critical = gapData.filter(d => d.tier === 'red').length;
            const warning = gapData.filter(d => d.tier === 'orange').length;
            const noBilling = gapData.filter(d => d.tier === 'grey').length;
            const avgDays = Math.round(gapData.reduce((sum, d) => sum + d.daysSince, 0) / gapData.length);

            document.getElementById('totalGaps').textContent = gapData.length;
            document.getElementById('criticalCount').textContent = critical;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('noBillingCount').textContent = noBilling;
            document.getElementById('avgGapDays').textContent = avgDays;

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = `tier-${row.tier}`;
                
                let statusBadge = '';
                if (row.tier === 'red') {
                    statusBadge = '<span class="badge badge-critical">🔴 ' + row.status + '</span>';
                } else if (row.tier === 'orange') {
                    statusBadge = '<span class="badge badge-warning">🟡 ' + row.status + '</span>';
                } else {
                    statusBadge = '<span class="badge badge-none">⚪ ' + row.status + '</span>';
                }

                let paStatusBadge = '';
                if (hasPAData) {
                    if (row.paStatus === 'Valid') {
                        paStatusBadge = `<span class="badge" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white;">✅ Valid (${row.paValidCount})</span>`;
                    } else if (row.paStatus === 'Expired') {
                        paStatusBadge = `<span class="badge badge-critical">❌ Expired (${row.paExpiredCount})</span>`;
                    } else {
                        paStatusBadge = '<span class="badge badge-none">⚪ None</span>';
                    }
                }

                // Format PA types with styled badges
                let paTypesFormatted = row.paTypes || '—';

                // Format PA expires with styled list
                let paExpiresFormatted = row.paExpires || '—';

                const cells = [
                    row.name,
                    `<strong style="text-align: center; display: block;">${row.fund}</strong>`,
                    row.provider,
                    `<span style="text-align: center; display: block;">${row.service}</span>`,
                    `<span style="text-align: center; display: block;">${row.lastBill}</span>`,
                    `<strong style="text-align: center; display: block;">${row.daysSince}</strong>`,
                    statusBadge,
                    paStatusBadge,
                    paTypesFormatted,
                    paExpiresFormatted
                ];

                columns.forEach((col, i) => {
                    if (col.visible) {
                        const td = document.createElement('td');
                        td.innerHTML = cells[i];
                        tr.appendChild(td);
                    }
                });

                // Add click handler to row for drill-down
                tr.style.cursor = 'pointer';
                tr.onclick = function() {
                    viewClientDetails(row.name);
                };

                tableBody.appendChild(tr);
            });

            document.getElementById('rowCount').textContent = `Showing ${filteredData.length} of ${gapData.length} rows • Click any row for detailed information`;
        }

        function updateAnalytics() {
            if (gapData.length === 0) return;

            const avgDays = Math.round(gapData.reduce((sum, d) => sum + d.daysSince, 0) / gapData.length);
            const providers = [...new Set(gapData.map(d => d.provider))];
            const services = [...new Set(gapData.map(d => d.service))];
            const funds = [...new Set(gapData.map(d => d.fund))];
            const urgentPercent = Math.round((gapData.filter(d => d.tier === 'red').length / gapData.length) * 100);
            const maxGap = Math.max(...gapData.map(d => d.daysSince));

            document.getElementById('avgDaysSince').textContent = avgDays;
            document.getElementById('uniqueProviders').textContent = providers.length;
            document.getElementById('uniqueServices').textContent = services.length;
            document.getElementById('urgentPercent').textContent = urgentPercent + '%';
            document.getElementById('uniqueFunds').textContent = funds.length;
            document.getElementById('maxGapDays').textContent = maxGap;

            Object.values(chartInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            chartInstances = {};

            createCharts();
        }

        function createCharts() {
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            chartInstances.severity = new Chart(severityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'Warning', 'No Billing'],
                    datasets: [{
                        data: [
                            gapData.filter(d => d.tier === 'red').length,
                            gapData.filter(d => d.tier === 'orange').length,
                            gapData.filter(d => d.tier === 'grey').length
                        ],
                        backgroundColor: ['#e74c3c', '#f39c12', '#95a5a6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });

            const serviceCounts = {};
            gapData.forEach(d => {
                serviceCounts[d.service] = (serviceCounts[d.service] || 0) + 1;
            });

            const serviceCtx = document.getElementById('serviceChart').getContext('2d');
            chartInstances.service = new Chart(serviceCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(serviceCounts),
                    datasets: [{
                        label: 'Number of Gaps',
                        data: Object.values(serviceCounts),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            const providerCounts = {};
            gapData.forEach(d => {
                if (d.provider !== 'No billing') {
                    providerCounts[d.provider] = (providerCounts[d.provider] || 0) + 1;
                }
            });

            const topProviders = Object.entries(providerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (topProviders.length > 0) {
                const providerCtx = document.getElementById('providerChart').getContext('2d');
                chartInstances.provider = new Chart(providerCtx, {
                    type: 'bar',
                    data: {
                        labels: topProviders.map(p => p[0]),
                        datasets: [{
                            label: 'Clients with Gaps',
                            data: topProviders.map(p => p[1]),
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            const dayRanges = {
                '0-30': 0,
                '31-60': 0,
                '61-90': 0,
                '91-120': 0,
                '120+': 0
            };

            gapData.forEach(d => {
                if (d.daysSince <= 30) dayRanges['0-30']++;
                else if (d.daysSince <= 60) dayRanges['31-60']++;
                else if (d.daysSince <= 90) dayRanges['61-90']++;
                else if (d.daysSince <= 120) dayRanges['91-120']++;
                else dayRanges['120+']++;
            });

            const daysCtx = document.getElementById('daysDistChart').getContext('2d');
            chartInstances.days = new Chart(daysCtx, {
                type: 'line',
                data: {
                    labels: Object.keys(dayRanges),
                    datasets: [{
                        label: 'Number of Clients',
                        data: Object.values(dayRanges),
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            const fundCounts = {};
            gapData.forEach(d => {
                fundCounts[d.fund] = (fundCounts[d.fund] || 0) + 1;
            });

            const fundCtx = document.getElementById('fundChart').getContext('2d');
            chartInstances.fund = new Chart(fundCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(fundCounts),
                    datasets: [{
                        data: Object.values(fundCounts),
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b',
                            '#fa709a',
                            '#fee140'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function exportToExcel() {
            if (gapData.length === 0) {
                showStatus('error', 'No data to export. Please analyze gaps first.');
                return;
            }

            const wb = XLSX.utils.book_new();

            const wsData = filteredData.map(row => ({
                'Name': row.name,
                'Fund': row.fund,
                'Provider': row.provider,
                'Service': row.service,
                'Last Bill': row.lastBill,
                'Days Since': row.daysSince,
                'Status': row.status,
                'Tier': row.tier.toUpperCase()
            }));

            const ws = XLSX.utils.json_to_sheet(wsData);
            ws['!cols'] = [
                {wch: 30}, {wch: 10}, {wch: 25}, {wch: 15},
                {wch: 12}, {wch: 12}, {wch: 20}, {wch: 10}
            ];
            XLSX.utils.book_append_sheet(wb, ws, 'Billing Gaps');

            const summaryData = [
                ['FOCUS EHR Billing Gap Analysis Report', ''],
                ['', ''],
                ['Summary Statistics', ''],
                ['', ''],
                ['Total Gaps Found:', gapData.length],
                ['Critical (Red):', gapData.filter(d => d.tier === 'red').length],
                ['Warning (Orange):', gapData.filter(d => d.tier === 'orange').length],
                ['No Billing (Grey):', gapData.filter(d => d.tier === 'grey').length],
                ['', ''],
                ['Average Days Since Billing:', Math.round(gapData.reduce((sum, d) => sum + d.daysSince, 0) / gapData.length)],
                ['Maximum Gap:', Math.max(...gapData.map(d => d.daysSince))],
                ['Unique Providers:', [...new Set(gapData.map(d => d.provider))].length],
                ['Unique Services:', [...new Set(gapData.map(d => d.service))].length],
                ['Unique Funding Sources:', [...new Set(gapData.map(d => d.fund))].length],
                ['', ''],
                ['Report Generated:', new Date().toLocaleString()],
                ['Generated By:', 'FOCUS EHR Analytics v3.0'],
                ['', ''],
                ['© 2025 Accelerate Solutions, LLC', '']
            ];

            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            wsSummary['!cols'] = [{wch: 30}, {wch: 20}];
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

            const providerStats = {};
            gapData.forEach(d => {
                if (!providerStats[d.provider]) {
                    providerStats[d.provider] = {
                        total: 0,
                        critical: 0,
                        warning: 0,
                        noBilling: 0
                    };
                }
                providerStats[d.provider].total++;
                if (d.tier === 'red') providerStats[d.provider].critical++;
                else if (d.tier === 'orange') providerStats[d.provider].warning++;
                else providerStats[d.provider].noBilling++;
            });

            const providerData = Object.entries(providerStats).map(([provider, stats]) => ({
                'Provider': provider,
                'Total Gaps': stats.total,
                'Critical': stats.critical,
                'Warning': stats.warning,
                'No Billing': stats.noBilling
            }));

            const wsProvider = XLSX.utils.json_to_sheet(providerData);
            wsProvider['!cols'] = [{wch: 30}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 12}];
            XLSX.utils.book_append_sheet(wb, wsProvider, 'Provider Analysis');

            const serviceStats = {};
            gapData.forEach(d => {
                if (!serviceStats[d.service]) {
                    serviceStats[d.service] = {
                        total: 0,
                        sumDays: 0
                    };
                }
                serviceStats[d.service].total++;
                serviceStats[d.service].sumDays += d.daysSince;
            });

            const serviceData = Object.entries(serviceStats).map(([service, stats]) => ({
                'Service Type': service,
                'Total Gaps': stats.total,
                'Average Days Since': Math.round(stats.sumDays / stats.total)
            }));

            const wsService = XLSX.utils.json_to_sheet(serviceData);
            wsService['!cols'] = [{wch: 20}, {wch: 12}, {wch: 18}];
            XLSX.utils.book_append_sheet(wb, wsService, 'Service Analysis');

           

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            const filename = `FOCUS_Billing_Gaps_${timestamp}.xlsx`;

            XLSX.writeFile(wb, filename);
            showStatus('success', `Excel file exported: ${filename}`);
        }

        function exportToCSV() {
            if (gapData.length === 0) {
                showStatus('error', 'No data to export.');
                return;
            }

            const headers = ['Name', 'Fund', 'Provider', 'Service', 'Last Bill', 'Days Since', 'Status', 'Tier'];
            const rows = filteredData.map(row => [
                row.name,
                row.fund,
                row.provider,
                row.service,
                row.lastBill,
                row.daysSince,
                row.status,
                row.tier.toUpperCase()
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `FOCUS_Billing_Gaps_${timestamp}.csv`;
            a.click();
            showStatus('success', 'CSV file exported');
        }

        function printReport() {
            window.print();
        }

        function refreshData() {
            if (activeData && billingData) {
                analyzeGaps();
            } else {
                showStatus('warning', 'No data to refresh. Please upload files first.');
            }
        }

        function extractService(title) {
            if (!title) return 'Unknown';
            const words = title.trim().split(/\s+/);
            if (words.length > 0) {
                return words[0].replace('Note', '');
            }
            return 'Unknown';
        }

        function fuzzyMatch(str1, str2) {
            const s1 = str1.toLowerCase();
            const s2 = str2.toLowerCase();
            
            let longer = s1;
            let shorter = s2;
            if (s1.length < s2.length) {
                longer = s2;
                shorter = s1;
            }
            
            const longerLength = longer.length;
            if (longerLength === 0) {
                return 1.0;
            }
            
            const editDistance = getEditDistance(longer, shorter);
            return (longerLength - editDistance) / parseFloat(longerLength);
        }

        function getEditDistance(s1, s2) {
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else {
                        if (j > 0) {
                            let newValue = costs[j - 1];
                            if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                                newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                            }
                            costs[j - 1] = lastValue;
                            lastValue = newValue;
                        }
                    }
                }
                if (i > 0) {
                    costs[s2.length] = lastValue;
                }
            }
            return costs[s2.length];
        }

        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${month}/${day}/${year}`;
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            const duration = (parseInt(document.getElementById('alertDuration')?.value) || 5) * 1000;
            statusEl.className = 'status ' + type;
            statusEl.textContent = message;
            statusEl.style.display = 'flex';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, duration);
            }
        }

        function sortTable(columnIndex) {
            const table = document.getElementById('dataTable');
            const tbody = table.getElementsByTagName('tbody')[0];
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            
            const dir = sortDirection[columnIndex] || 'asc';
            sortDirection[columnIndex] = dir === 'asc' ? 'desc' : 'asc';
            
            const headers = table.getElementsByTagName('th');
            for (let i = 0; i < headers.length; i++) {
                const indicator = headers[i].querySelector('.sort-indicator');
                if (i === columnIndex) {
                    indicator.textContent = dir === 'asc' ? '▲' : '▼';
                    indicator.className = 'sort-indicator ' + (dir === 'asc' ? '' : 'desc');
                } else {
                    indicator.textContent = '▼';
                    indicator.className = 'sort-indicator';
                }
            }
            
            rows.sort((a, b) => {
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                if (columnIndex === 5) {
                    const aNum = parseInt(aValue) || 0;
                    const bNum = parseInt(bValue) || 0;
                    return dir === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                if (columnIndex === 4) {
                    const aDate = aValue === 'Never' ? new Date(0) : new Date(aValue);
                    const bDate = bValue === 'Never' ? new Date(0) : new Date(bValue);
                    return dir === 'asc' ? aDate - bDate : bDate - aDate;
                }
                
                if (dir === 'asc') {
                    return aValue.localeCompare(bValue);
                } else {
                    return bValue.localeCompare(aValue);
                }
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        function filterTable() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const tbody = document.getElementById('tableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            let visibleCount = 0;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length; j++) {
                    const cellValue = cells[j].textContent || cells[j].innerText;
                    if (cellValue.toLowerCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
                if (found) visibleCount++;
            }

            document.getElementById('rowCount').textContent = `Showing ${visibleCount} of ${gapData.length} rows • Click any row for detailed information`;
        }

        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            if (tabName === 'analytics' && gapData.length > 0) {
                setTimeout(() => {
                    updateAnalytics();
                }, 100);
            }
        }

        function wizardNext(step) {
            document.querySelectorAll('.wizard-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.wizard-step').forEach(el => {
                el.classList.remove('active');
                el.classList.remove('completed');
            });

            for (let i = 1; i < step; i++) {
                document.getElementById(`wizardStep${i}`).classList.add('completed');
            }

            document.getElementById(`wizardStep${step}`).classList.add('active');
            document.getElementById(`wizardContent${step}`).style.display = 'block';
        }

        function wizardPrevious(step) {
            wizardNext(step);
        }

        function wizardHandleActiveFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file, 'active');
                document.getElementById('wizardActiveStatus').textContent = '✓ File loaded';
                checkWizardStep2();
            }
        }

        function wizardHandleBillingFile(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file, 'billing');
                document.getElementById('wizardBillingStatus').textContent = '✓ File loaded';
                checkWizardStep2();
            }
        }

        function checkWizardStep2() {
            const btn = document.getElementById('wizardStep2Next');
            if (activeData && billingData) {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        function wizardAnalyze() {
            document.getElementById('lookbackDays').value = document.getElementById('wizardLookback').value;
            document.getElementById('warnDays').value = document.getElementById('wizardWarn').value;
            
            const progress = document.getElementById('wizardProgress');
            const bar = document.getElementById('wizardProgressBar');
            
            progress.style.display = 'block';
            bar.style.width = '0%';
            
            setTimeout(() => { bar.style.width = '30%'; }, 100);
            setTimeout(() => { bar.style.width = '60%'; }, 500);
            setTimeout(() => { bar.style.width = '90%'; }, 1000);
            
            setTimeout(() => {
                analyzeGaps();
                bar.style.width = '100%';
                setTimeout(() => {
                    switchTab('dashboard', null);
                    showStatus('success', 'Analysis complete! View results in the Dashboard tab.');
                }, 500);
            }, 1500);
        }

        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
            closeFabMenu();
        }

        function closeHelp() {
            document.getElementById('helpModal').style.display = 'none';
        }

        function toggleFabMenu() {
            const menu = document.getElementById('fabMenu');
            menu.classList.toggle('active');
        }

        function closeFabMenu() {
            document.getElementById('fabMenu').classList.remove('active');
        }

        function clearData() {
            if (confirm('Clear all data and start over?')) {
                Object.values(chartInstances).forEach(chart => {
                    if (chart) chart.destroy();
                });
                chartInstances = {};
                
                activeData = null;
                billingData = null;
                gapData = [];
                filteredData = [];
                document.getElementById('tableBody').innerHTML = '';
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('summaryBar').style.display = 'none';
                
                document.getElementById('activeFile').value = '';
                document.getElementById('billingFile').value = '';
                document.getElementById('wizardActiveFile').value = '';
                document.getElementById('wizardBillingFile').value = '';
                document.getElementById('wizardActiveStatus').textContent = '';
                document.getElementById('wizardBillingStatus').textContent = '';
                
                showStatus('info', 'All data cleared');
                closeFabMenu();
            }
        }

        function loadSampleData() {
            activeData = [
                {MAID: '001', Name: 'John Doe', Status: 'Active', Funding: 'MED'},
                {MAID: '002', Name: 'Jane Smith', Status: 'Active', Funding: 'COM'},
                {MAID: '003', Name: 'Bob Johnson', Status: 'Active', Funding: 'PRI'},
                {MAID: '004', Name: 'Alice Brown', Status: 'Active', Funding: 'MED'},
                {MAID: '005', Name: 'Charlie Wilson', Status: 'Active', Funding: 'COM'},
                {MAID: '006', Name: 'Diana Martinez', Status: 'Active', Funding: 'MED'},
                {MAID: '007', Name: 'Edward Davis', Status: 'Active', Funding: 'PRI'},
                {MAID: '008', Name: 'Fiona Garcia', Status: 'Active', Funding: 'COM'}
            ];

            const today = new Date();
            billingData = [
                {MAID: '001', FullName: 'John Doe', 'Begin Date': new Date(today - 45 * 24 * 60 * 60 * 1000).toISOString(), 'Created By': 'Dr. Smith', Title: 'Therapy Session'},
                {MAID: '002', FullName: 'Jane Smith', 'Begin Date': new Date(today - 75 * 24 * 60 * 60 * 1000).toISOString(), 'Created By': 'Dr. Jones', Title: 'Consultation'},
                {MAID: '003', FullName: 'Bob Johnson', 'Begin Date': new Date(today - 20 * 24 * 60 * 60 * 1000).toISOString(), 'Created By': 'Dr. Brown', Title: 'Assessment'},
                {MAID: '004', FullName: 'Alice Brown', 'Begin Date': new Date(today - 95 * 24 * 60 * 60 * 1000).toISOString(), 'Created By': 'Dr. Smith', Title: 'Follow-up'},
                {MAID: '005', FullName: 'Charlie Wilson', 'Begin Date': new Date(today - 50 * 24 * 60 * 60 * 1000).toISOString(), 'Created By': 'Dr. Williams', Title: 'Treatment'}
            ];

            showStatus('success', 'Sample data loaded. Click "Analyze Gaps" to process.');
            closeFabMenu();
        }

        function downloadTemplate() {
            showStatus('info', 'Template files are available from FOCUS EHR using the download links in the Dashboard tab.');
            closeFabMenu();
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.style.filter = 'invert(1) hue-rotate(180deg)';
                document.querySelectorAll('img, canvas').forEach(el => {
                    el.style.filter = 'invert(1) hue-rotate(180deg)';
                });
                document.querySelector('.theme-toggle').textContent = '☀️';
            } else {
                document.body.style.filter = '';
                document.querySelectorAll('img, canvas').forEach(el => {
                    el.style.filter = '';
                });
                document.querySelector('.theme-toggle').textContent = '🌙';
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.getElementById('lookbackDays')?.addEventListener('change', function() {
            localStorage.setItem('lookbackDays', this.value);
        });

        document.getElementById('warnDays')?.addEventListener('change', function() {
            localStorage.setItem('warnDays', this.value);
        });
    </script>
</body>
</html>
